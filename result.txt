"""
–ë—Ä–∞—É–∑–µ—Ä–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ AWS Builder ID
–° –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –æ–±—Ö–æ–¥–æ–º fingerprinting (Canvas, WebGL)
"""

import time
import random
from typing import Optional, Callable
from DrissionPage import ChromiumPage, ChromiumOptions

import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent))

from core.config import get_config
from core.paths import get_paths
from .fingerprint_spoof import FingerprintSpoofer

# –°–µ–ª–µ–∫—Ç–æ—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ Playwright (–¥–µ–∫–∞–±—Ä—å 2025)
# AWS –∏—Å–ø–æ–ª—å–∑—É–µ—Ç data-testid –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤
SELECTORS = {
    'cookie_reject': [
        'text=Decline',  # –ê–Ω–≥–ª–∏–π—Å–∫–∏–π - –Ω–æ–≤—ã–π UI
        'text=–û—Ç–∫–ª–æ–Ω–∏—Ç—å',  # –†—É—Å—Å–∫–∏–π
        'text=Reject',
        'xpath://button[contains(text(), "Decline")]',
        'xpath://button[contains(text(), "Reject")]',
    ],
    'email_input': [
        '@placeholder=username@example.com',
        'aria:Email',
        '@type=email',
        '@data-testid=test-input',
    ],
    'continue_btn': [
        '@data-testid=test-primary-button',  # –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ Continue
        '@data-testid=signup-next-button',   # Continue –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏–º–µ–Ω–∏
        '@data-testid=email-verification-verify-button',  # Continue –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–æ–¥–∞
        'text=Continue',
    ],
    'name_input': [
        '@placeholder=Maria Jos√© Silva',  # –ê–∫—Ç—É–∞–ª—å–Ω—ã–π placeholder
        'aria:Name',
        '@data-testid=name-input',
    ],
    'code_input': [
        '@placeholder=6-digit',  # –ê–∫—Ç—É–∞–ª—å–Ω—ã–π placeholder
        'aria:Verification code',
    ],
    'password_input': [
        '@placeholder=Enter password',  # –ê–∫—Ç—É–∞–ª—å–Ω—ã–π placeholder
        'aria:Password',
    ],
    'confirm_password': [
        '@placeholder=Re-enter password',  # –ê–∫—Ç—É–∞–ª—å–Ω—ã–π placeholder
        'aria:Confirm password',
    ],
    'allow_access': [
        'text=Allow access',
        '@data-testid=allow-access-button',
    ],
}

# –ö–æ–Ω—Ç–µ–∫—Å—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü - –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞
PAGE_CONTEXTS = {
    'email': ['Get started', 'Sign in'],
    'name': ['Enter your name'],
    'verification': ['Verify your email'],
    'password': ['Create your password'],
    'allow_access': ['Allow access', 'Authorization'],
}

BROWSER_ARGS = [
    '--disable-blink-features=AutomationControlled',
    '--disable-dev-shm-usage',
]

PASSWORD_LENGTH = 16
PASSWORD_CHARS = {
    'upper': 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
    'lower': 'abcdefghijklmnopqrstuvwxyz',
    'digits': '0123456789',
    'special': '!@#$%^&*',  # –†–∞—Å—à–∏—Ä–µ–Ω –Ω–∞–±–æ—Ä —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤
}

# –¢–∞–π–º–∞—É—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
DEFAULT_TIMEOUTS = {
    'page_load': 10,
    'element_wait': 3,
    'page_transition': 5,
}

def load_settings():
    return get_config().to_dict()

def get_setting(path, default=None):
    return get_config().get(path, default)

BASE_DIR = get_paths().autoreg_dir


class BrowserAutomation:
    """–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å –æ–±—Ö–æ–¥–æ–º fingerprinting"""
    
    def __init__(self, headless: bool = None, spoof_fingerprint: bool = True):
        """
        Args:
            headless: –ó–∞–ø—É—Å–∫ –±–µ–∑ GUI (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫)
            spoof_fingerprint: –í–∫–ª—é—á–∏—Ç—å –æ–±—Ö–æ–¥ fingerprinting (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é True)
        """
        settings = load_settings()
        browser_settings = settings.get('browser', {})
        
        # headless –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
        if headless is None:
            headless = browser_settings.get('headless', False)
        
        self.settings = settings
        self.headless = headless
        self.verbose = settings.get('debug', {}).get('verbose', False)
        self.screenshots_on_error = browser_settings.get('screenshots_on_error', True)
        self.spoof_fingerprint = spoof_fingerprint
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±—Ä–∞—É–∑–µ—Ä–∞
        co = ChromiumOptions()
        
        if headless:
            co.headless()
        
        # –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π user-agent
        co.set_user_agent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36')
        
        # –†–∞–∑–º–µ—Ä –æ–∫–Ω–∞
        co.set_argument('--window-size=1280,900')
        
        if browser_settings.get('incognito', True):
            co.set_argument('--incognito')
        
        if browser_settings.get('devtools', False):
            co.set_argument('--auto-open-devtools-for-tabs')
        
        for arg in BROWSER_ARGS:
            co.set_argument(arg)
        
        self.page = ChromiumPage(co)
        self.fingerprint_spoofer = None
        self._cookie_closed = False  # –§–ª–∞–≥ —á—Ç–æ–±—ã –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å cookie –º–Ω–æ–≥–æ —Ä–∞–∑
        
        # –ò–Ω—ä–µ–∫—Ü–∏—è fingerprint spoofing
        if spoof_fingerprint:
            self._init_fingerprint_spoof()
        
        self._log("Browser initialized", f"headless={headless}, spoof={spoof_fingerprint}")
    
    def _init_fingerprint_spoof(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∏–Ω—ä–µ–∫—Ü–∏—è fingerprint spoofing"""
        try:
            # –°–æ–∑–¥–∞—ë–º spoofer —Å–æ —Å–ª—É—á–∞–π–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –¥–ª—è –∫–∞–∂–¥–æ–π —Å–µ—Å—Å–∏–∏
            self.fingerprint_spoofer = FingerprintSpoofer(self.page)
            self.fingerprint_spoofer.inject()
            
            if self.verbose:
                config = self.fingerprint_spoofer.get_config()
                self._log("Fingerprint spoof config", 
                         f"WebGL: {config['gpu_vendor'][:20]}... / {config['gpu_renderer'][:30]}...")
        except Exception as e:
            print(f"‚ö†Ô∏è Fingerprint spoof init failed: {e}")
            self.fingerprint_spoofer = None
    
    def _log(self, message: str, detail: str = ""):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —É—á—ë—Ç–æ–º verbose —Ä–µ–∂–∏–º–∞"""
        if self.verbose or not detail:
            print(f"üîß {message}" + (f" ({detail})" if detail else ""))
    
    def _find_element(self, selectors: list, timeout: int = None):
        """–ò—â–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –ø–æ —Å–ø–∏—Å–∫—É —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤"""
        timeout = timeout or self.settings.get('timeouts', {}).get('element_wait', 3)
        
        for selector in selectors:
            try:
                elem = self.page.ele(selector, timeout=timeout)
                if elem:
                    return elem
            except Exception:
                pass
        return None
    
    def _click_if_exists(self, selectors: list, timeout: int = 1) -> bool:
        """–ö–ª–∏–∫–∞–µ—Ç –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"""
        elem = self._find_element(selectors, timeout)
        if elem:
            self.human_click(elem)
            return True
        return False
    
    def wait_for_page_context(self, context_key: str, timeout: int = None) -> bool:
        """
        –ñ–¥—ë—Ç –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–∑–∞–≥–æ–ª–æ–≤–∫–∞).
        –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ –º—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–µ—Ä–µ–¥ –ø–æ–∏—Å–∫–æ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤.
        
        Args:
            context_key: –ö–ª—é—á –∏–∑ PAGE_CONTEXTS ('email', 'name', 'verification', 'password')
            timeout: –¢–∞–π–º–∞—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        
        Returns:
            True –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞–π–¥–µ–Ω
        """
        timeout = timeout or DEFAULT_TIMEOUTS['page_transition']
        contexts = PAGE_CONTEXTS.get(context_key, [])
        
        if not contexts:
            return True  # –ù–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        
        print(f"   ‚è≥ Waiting for page: {context_key}...")
        
        for _ in range(timeout * 2):
            for ctx in contexts:
                try:
                    if self.page.ele(f'text={ctx}', timeout=0.3):
                        print(f"   ‚úì Page context found: '{ctx}'")
                        time.sleep(0.3)  # –î–∞—ë–º React –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                        return True
                except:
                    pass
            time.sleep(0.5)
        
        print(f"   ‚ö†Ô∏è Page context not found: {context_key}")
        return False
    
    def wait_for_url_change(self, old_url: str, timeout: int = None) -> bool:
        """
        –ñ–¥—ë—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è URL –ø–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏—è.
        
        Args:
            old_url: –ü—Ä–µ–¥—ã–¥—É—â–∏–π URL
            timeout: –¢–∞–π–º–∞—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        
        Returns:
            True –µ—Å–ª–∏ URL –∏–∑–º–µ–Ω–∏–ª—Å—è
        """
        timeout = timeout or DEFAULT_TIMEOUTS['page_transition']
        
        for _ in range(timeout * 2):
            if self.page.url != old_url:
                time.sleep(0.5)  # –î–∞—ë–º —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è
                return True
            time.sleep(0.5)
        
        return False
    
    # ========================================================================
    # HUMAN-LIKE INPUT (–û–±—Ö–æ–¥ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ AWS FWCIM)
    # ========================================================================
    
    def human_type(self, element, text: str, click_first: bool = True, fast: bool = False):
        """
        –í–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç —Å —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ –º–µ–∂–¥—É –Ω–∞–∂–∞—Ç–∏—è–º–∏.
        AWS FWCIM –º–æ–¥—É–ª—å 54 –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç keyPressTimeIntervals.
        
        Args:
            element: –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–≤–æ–¥–∞
            text: –¢–µ–∫—Å—Ç –¥–ª—è –≤–≤–æ–¥–∞
            click_first: –ö–ª–∏–∫–Ω—É—Ç—å –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç –ø–µ—Ä–µ–¥ –≤–≤–æ–¥–æ–º
            fast: –ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º (–º–µ–Ω—å—à–µ –∑–∞–¥–µ—Ä–∂–∫–∏)
        """
        if click_first:
            element.click()
            time.sleep(random.uniform(0.05, 0.15))
        
        for i, char in enumerate(text):
            element.input(char)
            
            # –°–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–∏–º–≤–æ–ª–∞–º–∏
            if fast:
                base_delay = random.uniform(0.02, 0.05)  # 20-50ms –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–µ–∂–∏–º–∞
            else:
                base_delay = random.uniform(0.03, 0.08)  # 30-80ms –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º
            
            # –ò–Ω–æ–≥–¥–∞ –¥–µ–ª–∞–µ–º –ø–∞—É–∑—É –ø–æ–¥–æ–ª—å—à–µ (–∫–∞–∫ –±—É–¥—Ç–æ –¥—É–º–∞–µ–º) - —Ä–µ–¥–∫–æ
            if random.random() < 0.03:
                base_delay += random.uniform(0.1, 0.3)
            
            # –ü–æ—Å–ª–µ –ø—Ä–æ–±–µ–ª–∞ –∏–ª–∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ - —á—É—Ç—å –¥–æ–ª—å—à–µ
            if char in ' @._-':
                base_delay += random.uniform(0.03, 0.08)
            
            time.sleep(base_delay)
    
    def human_click(self, element):
        """
        –ö–ª–∏–∫–∞–µ—Ç –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É —Å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–º –¥–≤–∏–∂–µ–Ω–∏–µ–º –º—ã—à–∏.
        AWS FWCIM –º–æ–¥—É–ª—å 61 –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç mouseClickPositions –∏ mouseCycles.
        
        Args:
            element: –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –∫–ª–∏–∫–∞
        """
        try:
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —ç–ª–µ–º–µ–Ω—Ç–∞
            rect = element.rect
            
            # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–π —Å–ª—É—á–∞–π–Ω—ã–π —Å–¥–≤–∏–≥ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
            offset_x = random.randint(-5, 5)
            offset_y = random.randint(-3, 3)
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º actions –¥–ª—è –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ –∫–ª–∏–∫–∞
            # DrissionPage >= 4.0 –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç duration –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è
            try:
                self.page.actions.move_to(element, duration=random.uniform(0.3, 0.7))
                time.sleep(random.uniform(0.05, 0.15))
                self.page.actions.click()
            except:
                # Fallback –Ω–∞ –æ–±—ã—á–Ω—ã–π –∫–ª–∏–∫
                element.click()
            
            time.sleep(random.uniform(0.1, 0.3))
            
        except Exception as e:
            # Fallback –Ω–∞ –æ–±—ã—á–Ω—ã–π –∫–ª–∏–∫
            element.click()
            time.sleep(random.uniform(0.1, 0.2))
    
    @staticmethod
    def generate_password(length: int = PASSWORD_LENGTH) -> str:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç secrets –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç–∏.
        AWS –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–∞—Ä–æ–ª–∏ –Ω–∞ —É—Ç–µ—á–∫–∏ - –Ω—É–∂–Ω–∞ –≤—ã—Å–æ–∫–∞—è —ç–Ω—Ç—Ä–æ–ø–∏—è.
        """
        import secrets
        
        chars = ''.join(PASSWORD_CHARS.values())
        
        # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–∏–º–≤–æ–ª–æ–≤
        password = [
            secrets.choice(PASSWORD_CHARS['upper']),
            secrets.choice(PASSWORD_CHARS['lower']),
            secrets.choice(PASSWORD_CHARS['digits']),
            secrets.choice(PASSWORD_CHARS['special']),
        ]
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        password += [secrets.choice(chars) for _ in range(length - 4)]
        
        # –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º (secrets.SystemRandom –¥–ª—è –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–π —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏)
        secrets.SystemRandom().shuffle(password)
        
        return ''.join(password)
    
    def close_cookie_dialog(self, force: bool = False):
        """–ó–∞–∫—Ä—ã–≤–∞–µ—Ç –¥–∏–∞–ª–æ–≥ cookie –µ—Å–ª–∏ –æ–Ω –ø–æ—è–≤–∏–ª—Å—è"""
        if self._cookie_closed and not force:
            return False
            
        self._log("Checking for cookie dialog...")
        
        # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤ –¥–ª—è cookie –¥–∏–∞–ª–æ–≥–∞ (RU + EN)
        cookie_selectors = [
            # –†—É—Å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            'text=–û—Ç–∫–ª–æ–Ω–∏—Ç—å',
            'xpath://button[contains(text(), "–û—Ç–∫–ª–æ–Ω–∏—Ç—å")]',
            'xpath://button[text()="–û—Ç–∫–ª–æ–Ω–∏—Ç—å"]',
            # –ê–Ω–≥–ª–∏–π—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            'text=Reject',
            'text=Decline', 
            'text=Reject all',
            'xpath://button[contains(text(), "Reject")]',
            'xpath://button[contains(text(), "Decline")]',
            # AWS specific
            '@data-id=awsccc-cb-btn-decline',
            '#awsccc-cb-btn-decline',
        ]
        
        for selector in cookie_selectors:
            try:
                btn = self.page.ele(selector, timeout=0.3)
                if btn:
                    print(f"   üç™ Found cookie button: {selector}")
                    try:
                        # –ü—Ä–æ–±—É–µ–º JS –∫–ª–∏–∫ (–æ–±—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ)
                        self.page.run_js('arguments[0].click()', btn)
                    except:
                        try:
                            btn.click()
                        except:
                            pass
                    time.sleep(0.5)
                    self._cookie_closed = True
                    return True
            except Exception:
                pass
        
        return False
    
    def enter_email(self, email: str) -> bool:
        """–í–≤–æ–¥–∏—Ç email"""
        print(f"üìß Entering email: {email}")
        
        # –°–ù–ê–ß–ê–õ–ê –∑–∞–∫—Ä—ã–≤–∞–µ–º cookie –¥–∏–∞–ª–æ–≥ - –æ–Ω –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å –≤—Å—ë
        self.close_cookie_dialog(force=True)
        time.sleep(0.5)
        
        # –ñ–¥—ë–º –ø–æ—è–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã email (Get started / Sign in)
        if not self.wait_for_page_context('email', timeout=5):
            # –í–æ–∑–º–æ–∂–Ω–æ cookie –¥–∏–∞–ª–æ–≥ –µ—â—ë —Ä–∞–∑ –ø–æ—è–≤–∏–ª—Å—è
            self.close_cookie_dialog(force=True)
            time.sleep(0.5)
        
        selectors = [
            '@placeholder=username@example.com',
            'aria:Email',
            '@type=email',
            '@name=email',
            'tag:input@@type=text',
            'xpath://input[@type="text"]',
            'xpath://input[contains(@placeholder, "example.com")]',
            'xpath://input[@data-testid="test-input"]',
        ]
        
        email_input = None
        for selector in selectors:
            try:
                email_input = self.page.ele(selector, timeout=1)
                if email_input:
                    self._log(f"Found email field", selector)
                    break
            except Exception:
                pass
        
        if not email_input:
            self._debug_inputs()
            self.screenshot("error_no_email")
            raise Exception("Email field not found")
        
        email_input.clear()
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π –≤–≤–æ–¥ –¥–ª—è –æ–±—Ö–æ–¥–∞ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        self.human_type(email_input, email)
        return True
    
    def _debug_inputs(self):
        """–í—ã–≤–æ–¥–∏—Ç –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ input —ç–ª–µ–º–µ–Ω—Ç–∞—Ö"""
        print("   üîç Debug: searching for input elements...")
        try:
            inputs = self.page.eles('tag:input')
            for i, inp in enumerate(inputs[:5]):
                print(f"      Input {i}: type={inp.attr('type')}, placeholder={inp.attr('placeholder')}")
        except Exception as e:
            print(f"      Error: {e}")
    
    def click_continue(self) -> bool:
        """–ù–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É Continue"""
        print("‚û°Ô∏è Clicking Continue...")
        
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º cookie –µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞–∫—Ä—ã–ª–∏
        self.close_cookie_dialog()
        
        # –ü—Ä–æ–±—É–µ–º –∫–ª–∏–∫–Ω—É—Ç—å Continue
        for attempt in range(3):
            if self._click_if_exists(SELECTORS['continue_btn'], timeout=2):
                time.sleep(0.5)
                return True
            time.sleep(0.3)
        
        raise Exception("Continue button not found")
    
    def enter_name(self, name: str) -> bool:
        """–í–≤–æ–¥–∏—Ç –∏–º—è"""
        print(f"üìù Entering name: {name}")
        
        # –ñ–¥—ë–º –ø–æ—è–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏
        if not self.wait_for_page_context('name', timeout=10):
            print("   ‚ö†Ô∏è Name page context not found, trying anyway...")
        
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º cookie –¥–∏–∞–ª–æ–≥ –ü–ï–†–ï–î –≤–≤–æ–¥–æ–º (–æ–Ω –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É Continue)
        self.close_cookie_dialog(force=True)
        time.sleep(0.3)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—à–∏–±–∫—É AWS
        if self._check_aws_error():
            print("   ‚ö†Ô∏è AWS error detected, waiting and retrying...")
            time.sleep(2)
            # –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ X
            self._click_if_exists(['xpath://button[contains(@class, "close")]', 'aria:Close'], timeout=1)
            time.sleep(0.5)
        
        # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤ –¥–ª—è –ø–æ–ª—è –∏–º–µ–Ω–∏
        name_selectors = [
            '@placeholder=Maria Jos√© Silva',
            '@placeholder=Your name',
            '@placeholder=Full name',
            '@placeholder=Name',
            'aria:Name',
            'aria:Your name',
            '@name=name',
            '@id=name',
            '@data-testid=name-input',
            'xpath://input[contains(@placeholder, "name")]',
            'xpath://input[contains(@placeholder, "Name")]',
            'xpath://input[@type="text"]',
        ]
        
        name_input = None
        for selector in name_selectors:
            try:
                elem = self.page.ele(selector, timeout=2)
                if elem:
                    name_input = elem
                    print(f"   Found name field: {selector}")
                    break
            except:
                pass
        
        if not name_input:
            # Fallback - –∏—â–µ–º –ø–µ—Ä–≤—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π input
            print("   ‚ö†Ô∏è Name field not found by selectors, trying fallback...")
            try:
                inputs = self.page.eles('tag:input@@type=text')
                if inputs:
                    name_input = inputs[0]
                    print(f"   Found fallback input")
            except:
                pass
        
        if not name_input:
            print("   ‚ùå Name field not found!")
            self._debug_inputs()
            return False
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º CDP –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–≥–æ –≤–≤–æ–¥–∞ (–∫–∞–∫ –¥–ª—è –ø–∞—Ä–æ–ª—è)
        try:
            name_input.click()
            time.sleep(0.2)
            self.page.run_js('arguments[0].focus()', name_input)
            time.sleep(0.1)
            
            # –û—á–∏—â–∞–µ–º –ø–æ–ª–µ
            name_input.clear()
            time.sleep(0.1)
            
            # –í–≤–æ–¥–∏–º —á–µ—Ä–µ–∑ CDP –ø–æ—Å–∏–º–≤–æ–ª—å–Ω–æ
            print(f"   Typing name via CDP...")
            for char in name:
                self.page.run_cdp('Input.insertText', text=char)
                time.sleep(random.uniform(0.03, 0.08))
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤–≤–µ–ª–æ—Å—å
            time.sleep(0.2)
            val = name_input.attr('value') or ''
            print(f"   Name field value: '{val}'")
            
            if len(val) < len(name) // 2:
                # Fallback –Ω–∞ human_type
                print(f"   ‚ö†Ô∏è CDP input incomplete, trying human_type...")
                name_input.clear()
                self.human_type(name_input, name, click_first=False)
                
        except Exception as e:
            print(f"   ‚ö†Ô∏è CDP failed: {e}, using human_type...")
            name_input.clear()
            self.human_type(name_input, name)
        
        time.sleep(0.3)
        
        # –ö–ª–∏–∫–∞–µ–º Continue
        old_url = self.page.url
        self._click_if_exists(SELECTORS['continue_btn'], timeout=3)
        
        # –ñ–¥—ë–º –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        self.wait_for_url_change(old_url, timeout=5)
        time.sleep(random.uniform(0.3, 0.5))
        
        return True
    
    def enter_verification_code(self, code: str) -> bool:
        """–í–≤–æ–¥–∏—Ç –∫–æ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
        print(f"üîê Entering code: {code}")
        
        # –ñ–¥—ë–º –ø–æ—è–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
        if not self.wait_for_page_context('verification', timeout=10):
            print("   ‚ö†Ô∏è Verification page context not found, trying anyway...")
        
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º cookie –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –ø–µ—Ä–µ–¥ –≤–≤–æ–¥–æ–º –∫–æ–¥–∞
        self.close_cookie_dialog(force=True)
        time.sleep(0.3)
        
        code_input = self._find_element(SELECTORS['code_input'], timeout=30)
        if not code_input:
            raise Exception("Verification code field not found")
        
        # –ö–æ–¥ –≤–≤–æ–¥–∏–º —Ç–æ–∂–µ —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
        self.human_type(code_input, code)
        
        # –ï—â—ë —Ä–∞–∑ –∑–∞–∫—Ä—ã–≤–∞–µ–º cookie –ø–µ—Ä–µ–¥ –∫–ª–∏–∫–æ–º Continue (–º–æ–∂–µ—Ç –ø–æ—è–≤–∏—Ç—å—Å—è —Å–Ω–æ–≤–∞)
        time.sleep(0.3)
        self.close_cookie_dialog(force=True)
        time.sleep(0.3)
        
        # –ö–ª–∏–∫–∞–µ–º Continue —á–µ—Ä–µ–∑ JS —á—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ
        continue_btn = self._find_element(SELECTORS['continue_btn'], timeout=3)
        if continue_btn:
            try:
                self.page.run_js('arguments[0].click()', continue_btn)
            except:
                continue_btn.click()
        
        time.sleep(random.uniform(0.5, 1.5))
        
        return True
    
    def enter_password(self, password: str) -> bool:
        """–í–≤–æ–¥–∏—Ç –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –ø–∞—Ä–æ–ª—å"""
        print("üîë Entering password...")
        
        # –í–ê–ñ–ù–û: –ñ–¥—ë–º –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–∞—Ä–æ–ª—è
        # –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –∫–æ–≥–¥–∞ –ø–æ–ª—è –µ—â—ë –Ω–µ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏–ª–∏—Å—å
        if not self.wait_for_page_context('password', timeout=10):
            print("   ‚ö†Ô∏è Password page context not found, trying anyway...")
        
        time.sleep(0.5)  # –î–∞—ë–º React –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å –ø–æ–ª—è
        
        # –ò—â–µ–º –≤—Å–µ password –ø–æ–ª—è
        pwd_fields = self.page.eles('tag:input@@type=password', timeout=5)
        print(f"   Found {len(pwd_fields)} password fields")
        
        # Debug: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder'—ã
        for i, field in enumerate(pwd_fields[:3]):
            ph = field.attr('placeholder') or 'None'
            print(f"   Field {i}: placeholder='{ph}'")
        
        pwd1 = None
        pwd2 = None
        
        # –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: –ø–æ placeholder
        for field in pwd_fields:
            ph = (field.attr('placeholder') or '').lower()
            if 're-enter' in ph or 'confirm' in ph or 'repeat' in ph:
                pwd2 = field
            elif 'password' in ph or 'enter' in ph:
                pwd1 = field
        
        # –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ placeholder, –±–µ—Ä—ë–º –ø–æ –ø–æ—Ä—è–¥–∫—É
        if not pwd1 and len(pwd_fields) >= 1:
            # –ü–µ—Ä–≤–æ–µ –ø–æ–ª–µ –±–µ–∑ "re-enter" - —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ä–æ–ª—å
            for field in pwd_fields:
                ph = (field.attr('placeholder') or '').lower()
                if 're-enter' not in ph and 'confirm' not in ph:
                    pwd1 = field
                    break
            # –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –Ω–µ –Ω–∞—à–ª–∏ - –±–µ—Ä—ë–º –ø–µ—Ä–≤–æ–µ
            if not pwd1:
                pwd1 = pwd_fields[0]
        
        if not pwd2 and len(pwd_fields) >= 2:
            pwd2 = pwd_fields[1] if pwd_fields[1] != pwd1 else (pwd_fields[0] if pwd_fields[0] != pwd1 else None)
        
        if not pwd1:
            print("   ‚ö†Ô∏è No password fields found!")
            self._debug_inputs()
            self.screenshot("error_no_password")
            return False
        
        print(f"   pwd1: {pwd1.attr('placeholder')}")
        if pwd2:
            print(f"   pwd2: {pwd2.attr('placeholder')}")
        
        # –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –ø–æ–ª–µ - –ø–æ–¥–æ–∂–¥—ë–º –∏ –ø–æ–ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑
        if not pwd2 and len(pwd_fields) == 1:
            print("   ‚ö†Ô∏è Only 1 password field found, waiting for second...")
            time.sleep(2)
            pwd_fields = self.page.eles('tag:input@@type=password', timeout=5)
            if len(pwd_fields) >= 2:
                pwd2 = pwd_fields[1]
                print(f"   ‚úì Found second field: {pwd2.attr('placeholder')}")
        
        def input_via_cdp(element, text, field_name):
            """–í–≤–æ–¥ —á–µ—Ä–µ–∑ CDP - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å React –ø–æ–ª—è–º–∏"""
            print(f"   Clicking {field_name}...")
            element.click()
            time.sleep(0.2)
            
            # –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è —á–µ—Ä–µ–∑ JS
            self.page.run_js('arguments[0].focus()', element)
            time.sleep(0.1)
            
            # –í–≤–æ–¥–∏–º –ø–æ—Å–∏–º–≤–æ–ª—å–Ω–æ —á–µ—Ä–µ–∑ CDP
            print(f"   Typing into {field_name}...")
            for char in text:
                self.page.run_cdp('Input.insertText', text=char)
                time.sleep(random.uniform(0.03, 0.08))
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤–≤–µ–ª–æ—Å—å
            time.sleep(0.1)
            val = element.attr('value') or ''
            print(f"   {field_name} value length: {len(val)}")
            return len(val) > 0
        
        # –í–≤–æ–¥–∏–º –≤ –ü–ï–†–í–û–ï –ø–æ–ª–µ (Password)
        print(f"   === Field 1: Password ===")
        success1 = False
        try:
            success1 = input_via_cdp(pwd1, password, "Password")
            if success1:
                print(f"   ‚úì Field 1 done")
        except Exception as e:
            print(f"   ‚ö†Ô∏è CDP failed: {e}")
        
        if not success1:
            print(f"   Trying fallback for field 1...")
            try:
                pwd1.click()
                time.sleep(0.1)
                pwd1.clear()
                self.human_type(pwd1, password, click_first=False)
                success1 = True
            except Exception as e:
                print(f"   ‚ö†Ô∏è Fallback also failed: {e}")
        
        # –í–≤–æ–¥–∏–º –≤–æ –í–¢–û–†–û–ï –ø–æ–ª–µ (Re-enter password)
        if pwd2:
            time.sleep(0.3)
            print(f"   === Field 2: Confirm password ===")
            success2 = False
            try:
                success2 = input_via_cdp(pwd2, password, "Confirm")
                if success2:
                    print(f"   ‚úì Field 2 done")
            except Exception as e:
                print(f"   ‚ö†Ô∏è CDP failed: {e}")
            
            if not success2:
                print(f"   Trying fallback for field 2...")
                pwd2.click()
                time.sleep(0.1)
                pwd2.clear()
                self.human_type(pwd2, password, click_first=False)
        
        time.sleep(0.3)
        print("‚û°Ô∏è Clicking Continue after password...")
        old_url = self.page.url
        self._click_if_exists(SELECTORS['continue_btn'], timeout=2)
        time.sleep(1)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—à–∏–±–∫—É "leaked password"
        if self._check_password_error():
            print("   ‚ö†Ô∏è Password rejected (possibly leaked), generating new one...")
            new_password = self.generate_password(18)  # –î–ª–∏–Ω–Ω–µ–µ –¥–ª—è –±–æ–ª—å—à–µ–π —ç–Ω—Ç—Ä–æ–ø–∏–∏
            return self.enter_password(new_password)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å (—É—Å–ø–µ—à–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥)
        if self.page.url == old_url:
            # –í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å
            time.sleep(1)
        
        self._log(f"URL after password", self.page.url[:60])
        
        return True
    
    def _check_password_error(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–∫–∏ –æ —Å–ª–∞–±–æ–º/—É—Ç—ë–∫—à–µ–º –ø–∞—Ä–æ–ª–µ"""
        error_texts = [
            'publicly known',
            'leaked',
            'data set',
            'try a different password',
            'password is too weak',
        ]
        
        for text in error_texts:
            try:
                if self.page.ele(f'text={text}', timeout=0.5):
                    return True
            except:
                pass
        
        return False
    
    def click_allow_access(self) -> bool:
        """–ù–∞–∂–∏–º–∞–µ—Ç Allow access"""
        print("‚úÖ Looking for Allow access button...")
        
        for attempt in range(10):
            selectors = [
                'text=Allow access',
                '@data-testid=allow-access-button',
                'xpath://button[contains(text(), "Allow")]',
                'tag:button@@text()=Allow access',
            ]
            
            for selector in selectors:
                try:
                    btn = self.page.ele(selector, timeout=1)
                    if btn:
                        print(f"üîì Clicking Allow access (attempt {attempt + 1})...")
                        
                        try:
                            btn.click()
                        except:
                            self.page.run_js('arguments[0].click()', btn)
                        
                        time.sleep(1)
                        
                        if '127.0.0.1' in self.page.url:
                            return True
                except Exception:
                    pass
            
            time.sleep(0.5)
        
        print("   ‚ö†Ô∏è Allow access button didn't work")
        self.screenshot("error_allow_access")
        return False
    
    def wait_for_callback(self, timeout: int = None) -> bool:
        """–ñ–¥—ë—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ callback"""
        timeout = timeout or self.settings.get('timeouts', {}).get('oauth_callback', 60)
        print(f"‚è≥ Waiting for callback redirect ({timeout}s)...")
        
        for _ in range(timeout):
            current_url = self.page.url
            if '127.0.0.1' in current_url and 'oauth/callback' in current_url:
                return True
            time.sleep(1)
        
        return False
    
    @property
    def current_url(self) -> str:
        return self.page.url
    
    def navigate(self, url: str):
        """–ü–µ—Ä–µ—Ö–æ–¥ –ø–æ URL"""
        print(f"üìç Opening page...")
        self.page.get(url)
        
        print("‚è≥ Waiting for page load...")
        # –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        try:
            self.page.wait.doc_loaded(timeout=15)
        except:
            pass
        
        self._log(f"URL", self.page.url[:60] + "..." if len(self.page.url) > 60 else self.page.url)
        
        # –ñ–¥—ë–º –ø–æ—è–≤–ª–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        for i in range(20):
            time.sleep(0.3)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å (–µ—Å—Ç—å email input –∏–ª–∏ —Ç–µ–∫—Å—Ç Get started)
            try:
                if self.page.ele('@placeholder=username@example.com', timeout=0.3):
                    print("   ‚úì Email field found")
                    break
                if self.page.ele('text=Get started', timeout=0.3):
                    print("   ‚úì Page loaded (Get started)")
                    break
                if self.page.ele('text=Sign in', timeout=0.3):
                    print("   ‚úì Page loaded (Sign in)")
                    break
            except:
                pass
        
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º cookie –¥–∏–∞–ª–æ–≥ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
        self.close_cookie_dialog()
    
    def check_aws_error(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–∫–∏ AWS"""
        try:
            error_text = self.page.ele("text=It's not you, it's us", timeout=1)
            if error_text:
                print("‚ö†Ô∏è AWS temporary error, need to wait and retry")
                return True
        except:
            pass
        return False
    
    def _check_aws_error(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–∫–∏ AWS –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ)"""
        error_texts = [
            'error processing your request',
            'Please try again',
            "It's not you, it's us",
            'Something went wrong',
        ]
        
        for text in error_texts:
            try:
                if self.page.ele(f'text={text}', timeout=0.5):
                    return True
            except:
                pass
        
        return False
    
    def screenshot(self, name: str = "debug") -> Optional[str]:
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏"""
        if not self.screenshots_on_error:
            return None
        
        try:
            filename = str(BASE_DIR / f"{name}_{int(time.time())}.png")
            self.page.get_screenshot(path=filename)
            print(f"üì∏ Screenshot: {filename}")
            return filename
        except Exception as e:
            print(f"‚ö†Ô∏è Screenshot failed: {e}")
            return None
    
    def pause_for_debug(self, message: str = "Paused for debugging"):
        """–ü–∞—É–∑–∞ –¥–ª—è —Ä—É—á–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏"""
        if self.settings.get('debug', {}).get('pause_on_error', False):
            print(f"\n‚è∏Ô∏è {message}")
            print("   Press Enter to continue...")
            input()
    
    def get_fingerprint_config(self) -> Optional[dict]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é fingerprint spoofing"""
        if self.fingerprint_spoofer:
            return self.fingerprint_spoofer.get_config()
        return None
    
    def close(self):
        """–ó–∞–∫—Ä—ã—Ç–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞"""
        try:
            self.page.quit()
        except Exception:
            pass
"""
PoC –¥–ª—è –æ–±—Ö–æ–¥–∞ Browser Fingerprinting (AWS FWCIM) v2.0

–ú–æ–¥—É–ª—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–¥–º–µ–Ω—É —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:
- Canvas Fingerprinting (toDataURL —Å —à—É–º–æ–º)
- WebGL Fingerprinting (–ø–æ–¥–º–µ–Ω–∞ vendor/renderer + extensions consistency)
- Audio Fingerprinting (AudioContext noise)
- Screen Resolution Spoofing
- toString() Stealth (–º–∞—Å–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–¥ native code, –≤–∫–ª—é—á–∞—è .call/.apply)
- Error.stack sanitization
- Notification permissions fix

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç DrissionPage –¥–ª—è –∏–Ω—ä–µ–∫—Ü–∏–∏ JS –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
—á–µ—Ä–µ–∑ Chrome DevTools Protocol (Page.addScriptToEvaluateOnNewDocument)
"""

import random
from typing import Optional

# ============================================================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–ü–£–§–ò–ù–ì–ê v2.0
# ============================================================================

# –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ GPU (vendor + renderer + extensions + numeric params)
# Numeric params –∫—Ä–∏—Ç–∏—á–Ω—ã - AWS FWCIM –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏—Ö —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Å GPU
GPU_PROFILES = {
    "intel_uhd_620": {
        "vendor": "Intel Inc.",
        "renderer": "Intel(R) UHD Graphics 620",
        "extensions": [
            "ANGLE_instanced_arrays", "EXT_blend_minmax", "EXT_color_buffer_half_float",
            "EXT_float_blend", "EXT_frag_depth", "EXT_shader_texture_lod",
            "EXT_texture_compression_bptc", "EXT_texture_compression_rgtc",
            "EXT_texture_filter_anisotropic", "EXT_sRGB", "OES_element_index_uint",
            "OES_fbo_render_mipmap", "OES_standard_derivatives", "OES_texture_float",
            "OES_texture_float_linear", "OES_texture_half_float", "OES_texture_half_float_linear",
            "OES_vertex_array_object", "WEBGL_color_buffer_float", "WEBGL_compressed_texture_s3tc",
            "WEBGL_compressed_texture_s3tc_srgb", "WEBGL_debug_renderer_info",
            "WEBGL_debug_shaders", "WEBGL_depth_texture", "WEBGL_draw_buffers",
            "WEBGL_lose_context", "WEBGL_multi_draw"
        ],
        "params": {
            "MAX_TEXTURE_SIZE": 16384,
            "MAX_RENDERBUFFER_SIZE": 16384,
            "MAX_VIEWPORT_DIMS": [16384, 16384],
            "MAX_VERTEX_ATTRIBS": 16,
            "MAX_VERTEX_UNIFORM_VECTORS": 4096,
            "MAX_FRAGMENT_UNIFORM_VECTORS": 1024,
            "MAX_VARYING_VECTORS": 30,
            "MAX_TEXTURE_IMAGE_UNITS": 16,
            "MAX_VERTEX_TEXTURE_IMAGE_UNITS": 16,
            "MAX_COMBINED_TEXTURE_IMAGE_UNITS": 32,
            "ALIASED_LINE_WIDTH_RANGE": [1, 1],
            "ALIASED_POINT_SIZE_RANGE": [1, 1024]
        }
    },
    "intel_iris_xe": {
        "vendor": "Intel Inc.",
        "renderer": "Intel(R) Iris(R) Xe Graphics",
        "extensions": [
            "ANGLE_instanced_arrays", "EXT_blend_minmax", "EXT_color_buffer_half_float",
            "EXT_float_blend", "EXT_frag_depth", "EXT_shader_texture_lod",
            "EXT_texture_compression_bptc", "EXT_texture_compression_rgtc",
            "EXT_texture_filter_anisotropic", "EXT_sRGB", "KHR_parallel_shader_compile",
            "OES_element_index_uint", "OES_fbo_render_mipmap", "OES_standard_derivatives",
            "OES_texture_float", "OES_texture_float_linear", "OES_texture_half_float",
            "OES_texture_half_float_linear", "OES_vertex_array_object",
            "WEBGL_color_buffer_float", "WEBGL_compressed_texture_s3tc",
            "WEBGL_compressed_texture_s3tc_srgb", "WEBGL_debug_renderer_info",
            "WEBGL_debug_shaders", "WEBGL_depth_texture", "WEBGL_draw_buffers",
            "WEBGL_lose_context", "WEBGL_multi_draw"
        ],
        "params": {
            "MAX_TEXTURE_SIZE": 16384,
            "MAX_RENDERBUFFER_SIZE": 16384,
            "MAX_VIEWPORT_DIMS": [16384, 16384],
            "MAX_VERTEX_ATTRIBS": 16,
            "MAX_VERTEX_UNIFORM_VECTORS": 4096,
            "MAX_FRAGMENT_UNIFORM_VECTORS": 1024,
            "MAX_VARYING_VECTORS": 31,
            "MAX_TEXTURE_IMAGE_UNITS": 16,
            "MAX_VERTEX_TEXTURE_IMAGE_UNITS": 16,
            "MAX_COMBINED_TEXTURE_IMAGE_UNITS": 32,
            "ALIASED_LINE_WIDTH_RANGE": [1, 1],
            "ALIASED_POINT_SIZE_RANGE": [1, 1024]
        }
    },
    "nvidia_gtx_1650": {
        "vendor": "NVIDIA Corporation",
        "renderer": "NVIDIA GeForce GTX 1650",
        "extensions": [
            "ANGLE_instanced_arrays", "EXT_blend_minmax", "EXT_color_buffer_half_float",
            "EXT_float_blend", "EXT_frag_depth", "EXT_shader_texture_lod",
            "EXT_texture_compression_bptc", "EXT_texture_compression_rgtc",
            "EXT_texture_filter_anisotropic", "EXT_sRGB", "KHR_parallel_shader_compile",
            "NV_shader_noperspective_interpolation", "OES_element_index_uint",
            "OES_fbo_render_mipmap", "OES_standard_derivatives", "OES_texture_float",
            "OES_texture_float_linear", "OES_texture_half_float",
            "OES_texture_half_float_linear", "OES_vertex_array_object",
            "WEBGL_color_buffer_float", "WEBGL_compressed_texture_s3tc",
            "WEBGL_compressed_texture_s3tc_srgb", "WEBGL_debug_renderer_info",
            "WEBGL_debug_shaders", "WEBGL_depth_texture", "WEBGL_draw_buffers",
            "WEBGL_lose_context", "WEBGL_multi_draw"
        ],
        "params": {
            "MAX_TEXTURE_SIZE": 32768,
            "MAX_RENDERBUFFER_SIZE": 32768,
            "MAX_VIEWPORT_DIMS": [32768, 32768],
            "MAX_VERTEX_ATTRIBS": 16,
            "MAX_VERTEX_UNIFORM_VECTORS": 4096,
            "MAX_FRAGMENT_UNIFORM_VECTORS": 4096,
            "MAX_VARYING_VECTORS": 31,
            "MAX_TEXTURE_IMAGE_UNITS": 32,
            "MAX_VERTEX_TEXTURE_IMAGE_UNITS": 32,
            "MAX_COMBINED_TEXTURE_IMAGE_UNITS": 64,
            "ALIASED_LINE_WIDTH_RANGE": [1, 1],
            "ALIASED_POINT_SIZE_RANGE": [1, 2048]
        }
    },
    "nvidia_rtx_3060": {
        "vendor": "NVIDIA Corporation",
        "renderer": "NVIDIA GeForce RTX 3060",
        "extensions": [
            "ANGLE_instanced_arrays", "EXT_blend_minmax", "EXT_color_buffer_half_float",
            "EXT_float_blend", "EXT_frag_depth", "EXT_shader_texture_lod",
            "EXT_texture_compression_bptc", "EXT_texture_compression_rgtc",
            "EXT_texture_filter_anisotropic", "EXT_sRGB", "KHR_parallel_shader_compile",
            "NV_shader_noperspective_interpolation", "OES_element_index_uint",
            "OES_fbo_render_mipmap", "OES_standard_derivatives", "OES_texture_float",
            "OES_texture_float_linear", "OES_texture_half_float",
            "OES_texture_half_float_linear", "OES_vertex_array_object",
            "WEBGL_color_buffer_float", "WEBGL_compressed_texture_s3tc",
            "WEBGL_compressed_texture_s3tc_srgb", "WEBGL_debug_renderer_info",
            "WEBGL_debug_shaders", "WEBGL_depth_texture", "WEBGL_draw_buffers",
            "WEBGL_lose_context", "WEBGL_multi_draw", "WEBGL_provoking_vertex"
        ],
        "params": {
            "MAX_TEXTURE_SIZE": 32768,
            "MAX_RENDERBUFFER_SIZE": 32768,
            "MAX_VIEWPORT_DIMS": [32768, 32768],
            "MAX_VERTEX_ATTRIBS": 16,
            "MAX_VERTEX_UNIFORM_VECTORS": 4096,
            "MAX_FRAGMENT_UNIFORM_VECTORS": 4096,
            "MAX_VARYING_VECTORS": 31,
            "MAX_TEXTURE_IMAGE_UNITS": 32,
            "MAX_VERTEX_TEXTURE_IMAGE_UNITS": 32,
            "MAX_COMBINED_TEXTURE_IMAGE_UNITS": 64,
            "ALIASED_LINE_WIDTH_RANGE": [1, 1],
            "ALIASED_POINT_SIZE_RANGE": [1, 2048]
        }
    },
    "amd_rx_580": {
        "vendor": "AMD",
        "renderer": "AMD Radeon RX 580",
        "extensions": [
            "ANGLE_instanced_arrays", "EXT_blend_minmax", "EXT_color_buffer_half_float",
            "EXT_float_blend", "EXT_frag_depth", "EXT_shader_texture_lod",
            "EXT_texture_compression_bptc", "EXT_texture_compression_rgtc",
            "EXT_texture_filter_anisotropic", "EXT_sRGB", "OES_element_index_uint",
            "OES_fbo_render_mipmap", "OES_standard_derivatives", "OES_texture_float",
            "OES_texture_float_linear", "OES_texture_half_float",
            "OES_texture_half_float_linear", "OES_vertex_array_object",
            "WEBGL_color_buffer_float", "WEBGL_compressed_texture_s3tc",
            "WEBGL_compressed_texture_s3tc_srgb", "WEBGL_debug_renderer_info",
            "WEBGL_debug_shaders", "WEBGL_depth_texture", "WEBGL_draw_buffers",
            "WEBGL_lose_context", "WEBGL_multi_draw"
        ],
        "params": {
            "MAX_TEXTURE_SIZE": 16384,
            "MAX_RENDERBUFFER_SIZE": 16384,
            "MAX_VIEWPORT_DIMS": [16384, 16384],
            "MAX_VERTEX_ATTRIBS": 16,
            "MAX_VERTEX_UNIFORM_VECTORS": 4096,
            "MAX_FRAGMENT_UNIFORM_VECTORS": 4096,
            "MAX_VARYING_VECTORS": 32,
            "MAX_TEXTURE_IMAGE_UNITS": 32,
            "MAX_VERTEX_TEXTURE_IMAGE_UNITS": 32,
            "MAX_COMBINED_TEXTURE_IMAGE_UNITS": 64,
            "ALIASED_LINE_WIDTH_RANGE": [1, 1],
            "ALIASED_POINT_SIZE_RANGE": [1, 8192]
        }
    },
}

# –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–∞ –¥–ª—è —Å–ø—É—Ñ–∏–Ω–≥–∞
SCREEN_RESOLUTIONS = [
    {"width": 1920, "height": 1080, "availHeight": 1040},  # Full HD
    {"width": 2560, "height": 1440, "availHeight": 1400},  # 2K
    {"width": 1366, "height": 768, "availHeight": 728},    # Laptop HD
    {"width": 1536, "height": 864, "availHeight": 824},    # Laptop scaled
    {"width": 1440, "height": 900, "availHeight": 860},    # MacBook
]

# –¢–∞–π–º–∑–æ–Ω—ã - –ö–†–ò–¢–ò–ß–ù–û: –¥–æ–ª–∂–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å IP –ø—Ä–æ–∫—Å–∏!
# offset - —Å–º–µ—â–µ–Ω–∏–µ –≤ –º–∏–Ω—É—Ç–∞—Ö (–¥–ª—è JS getTimezoneOffset, –æ–±—Ä–∞—Ç–Ω—ã–π –∑–Ω–∞–∫)
# –ù–∞–ø—Ä–∏–º–µ—Ä: UTC+3 (–ú–æ—Å–∫–≤–∞) = offset -180, UTC-5 (NY) = offset 300
TIMEZONE_PROFILES = {
    "europe_moscow": {"id": "Europe/Moscow", "offset": -180, "locale": "ru-RU"},
    "europe_berlin": {"id": "Europe/Berlin", "offset": -60, "locale": "de-DE"},
    "europe_london": {"id": "Europe/London", "offset": 0, "locale": "en-GB"},
    "america_new_york": {"id": "America/New_York", "offset": 300, "locale": "en-US"},
    "america_los_angeles": {"id": "America/Los_Angeles", "offset": 480, "locale": "en-US"},
    "asia_tokyo": {"id": "Asia/Tokyo", "offset": -540, "locale": "ja-JP"},
}

# –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∞—É–¥–∏–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –¥–ª—è Windows
AUDIO_DEVICES_WINDOWS = [
    {"deviceId": "default", "kind": "audioinput", "label": "Microphone (Realtek High Definition Audio)", "groupId": "audio1"},
    {"deviceId": "communications", "kind": "audiooutput", "label": "Speakers (Realtek High Definition Audio)", "groupId": "audio1"},
    {"deviceId": "default", "kind": "videoinput", "label": "Integrated Webcam", "groupId": "video1"},
]

# –£—Ä–æ–≤–µ–Ω—å —à—É–º–∞ –¥–ª—è Canvas (0.001 - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π, –Ω–µ–∑–∞–º–µ—Ç–Ω—ã–π –≥–ª–∞–∑—É)
CANVAS_NOISE_ALPHA = 0.001


def generate_gpu_profile() -> dict:
    """–í—ã–±–∏—Ä–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π GPU –ø—Ä–æ—Ñ–∏–ª—å"""
    profile_name = random.choice(list(GPU_PROFILES.keys()))
    return GPU_PROFILES[profile_name].copy()


def generate_screen_config() -> dict:
    """–í—ã–±–∏—Ä–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞"""
    return random.choice(SCREEN_RESOLUTIONS).copy()


def get_stealth_js(gpu_profile: dict = None, screen_config: dict = None,
                   timezone_config: dict = None,
                   canvas_noise: float = CANVAS_NOISE_ALPHA,
                   seed: int = None) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JavaScript payload –¥–ª—è –∏–Ω—ä–µ–∫—Ü–∏–∏ –≤ –±—Ä–∞—É–∑–µ—Ä v3.3
    
    Args:
        gpu_profile: –ü—Ä–æ—Ñ–∏–ª—å GPU (vendor, renderer, extensions, params)
        screen_config: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞
        timezone_config: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–∞–π–º–∑–æ–Ω—ã (id, offset, locale) - –î–û–õ–ñ–ù–ê —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å IP!
        canvas_noise: –£—Ä–æ–≤–µ–Ω—å —à—É–º–∞ –¥–ª—è Canvas
        seed: Seed –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª
    
    Returns:
        JavaScript –∫–æ–¥ –¥–ª—è –∏–Ω—ä–µ–∫—Ü–∏–∏
    """
    if seed:
        random.seed(seed)
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã
    if gpu_profile is None:
        gpu_profile = generate_gpu_profile()
    
    if screen_config is None:
        screen_config = generate_screen_config()
    
    # –¢–∞–π–º–∑–æ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –ú–æ—Å–∫–≤–∞ (–¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö IP)
    if timezone_config is None:
        timezone_config = TIMEZONE_PROFILES["europe_moscow"]
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π noise seed
    noise_seed = seed or random.randint(1, 1000000)
    
    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º extensions –≤ JS –º–∞—Å—Å–∏–≤
    extensions_js = str(gpu_profile.get("extensions", [])).replace("'", '"')
    
    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º WebGL params –≤ JS –æ–±—ä–µ–∫—Ç
    import json
    params_js = json.dumps(gpu_profile.get("params", {}))
    audio_devices_js = json.dumps(AUDIO_DEVICES_WINDOWS)
    
    return f'''
(() => {{
    // ========================================================================
    // AWS FWCIM Fingerprint Spoofing PoC v2.0
    // ========================================================================
    // –ü–æ–ª–Ω—ã–π –æ–±—Ö–æ–¥ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ AWS —Å –∑–∞–∫—Ä—ã—Ç–∏–µ–º –≤—Å–µ—Ö –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –≤–µ–∫—Ç–æ—Ä–æ–≤ –¥–µ—Ç–µ–∫—Ç–∞
    // ========================================================================
    
    const SPOOF_CONFIG = {{
        webgl: {{
            vendor: "{gpu_profile['vendor']}",
            renderer: "{gpu_profile['renderer']}",
            extensions: {extensions_js},
            params: {params_js}
        }},
        canvas: {{
            noiseAlpha: {canvas_noise},
            noiseSeed: {noise_seed}
        }},
        screen: {{
            width: {screen_config['width']},
            height: {screen_config['height']},
            availWidth: {screen_config['width']},
            availHeight: {screen_config['availHeight']},
            colorDepth: 24,
            pixelDepth: 24
        }},
        navigator: {{
            platform: 'Win32'  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å —Ç–∏–ø–∏—á–Ω—ã–º Windows UA
        }},
        timezone: {{
            id: '{timezone_config["id"]}',
            offset: {timezone_config["offset"]},  // getTimezoneOffset() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç—Ç–æ
            locale: '{timezone_config["locale"]}'
        }},
        audio: {{
            devices: {audio_devices_js}
        }},
        debug: false
    }};
    
    const log = (...args) => {{
        if (SPOOF_CONFIG.debug) console.log('[FP-Spoof]', ...args);
    }};
    
    // ========================================================================
    // –£–¢–ò–õ–ò–¢–´
    // ========================================================================
    
    // –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ö–µ—à –æ—Ç —Å—Ç—Ä–æ–∫–∏ (–¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ —à—É–º–∞ –ø–æ –¥–æ–º–µ–Ω—É)
    const hashCode = (str) => {{
        let hash = 0;
        for (let i = 0; i < str.length; i++) {{
            hash = ((hash << 5) - hash) + str.charCodeAt(i);
            hash = hash & hash;
        }}
        return Math.abs(hash);
    }};
    
    // PRNG —Å seed –æ—Ç –¥–æ–º–µ–Ω–∞ - —à—É–º —Å—Ç–∞–±–∏–ª–µ–Ω –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–∞–π—Ç–∞
    const domainSeed = hashCode(window.location.hostname + navigator.userAgent);
    let noiseSeed = domainSeed || SPOOF_CONFIG.canvas.noiseSeed;
    const seededRandom = () => {{
        noiseSeed = (noiseSeed * 9301 + 49297) % 233280;
        return noiseSeed / 233280;
    }};
    
    // –ö–∞—Ä—Ç–∞ –ø–æ–¥–¥–µ–ª–æ–∫ –¥–ª—è toString stealth
    const spoofedFunctions = new Map();
    
    // ========================================================================
    // 1. CANVAS FINGERPRINT SPOOFING
    // ========================================================================
    
    const originalToDataURL = HTMLCanvasElement.prototype.toDataURL;
    const originalToBlob = HTMLCanvasElement.prototype.toBlob;
    const originalGetImageData = CanvasRenderingContext2D.prototype.getImageData;
    
    const addCanvasNoise = (canvas) => {{
        if (canvas.width <= 0 || canvas.height <= 0) return;
        try {{
            const ctx = canvas.getContext('2d');
            if (!ctx) return;
            
            const originalComposite = ctx.globalCompositeOperation;
            ctx.globalCompositeOperation = 'source-over';
            
            const pixelCount = Math.floor(seededRandom() * 3) + 1;
            for (let i = 0; i < pixelCount; i++) {{
                const x = Math.floor(seededRandom() * canvas.width);
                const y = Math.floor(seededRandom() * canvas.height);
                const r = Math.floor(seededRandom() * 10);
                const g = Math.floor(seededRandom() * 10);
                const b = Math.floor(seededRandom() * 10);
                ctx.fillStyle = `rgba(${{r}}, ${{g}}, ${{b}}, ${{SPOOF_CONFIG.canvas.noiseAlpha}})`;
                ctx.fillRect(x, y, 1, 1);
            }}
            
            ctx.globalCompositeOperation = originalComposite;
            log('Canvas noise added:', pixelCount, 'pixels');
        }} catch (e) {{}}
    }};
    
    const spoofedToDataURL = new Proxy(originalToDataURL, {{
        apply(target, thisArg, args) {{
            addCanvasNoise(thisArg);
            return Reflect.apply(target, thisArg, args);
        }}
    }});
    
    const spoofedToBlob = new Proxy(originalToBlob, {{
        apply(target, thisArg, args) {{
            addCanvasNoise(thisArg);
            return Reflect.apply(target, thisArg, args);
        }}
    }});
    
    const spoofedGetImageData = new Proxy(originalGetImageData, {{
        apply(target, thisArg, args) {{
            if (thisArg.canvas) addCanvasNoise(thisArg.canvas);
            return Reflect.apply(target, thisArg, args);
        }}
    }});
    
    spoofedFunctions.set(spoofedToDataURL, 'toDataURL');
    spoofedFunctions.set(spoofedToBlob, 'toBlob');
    spoofedFunctions.set(spoofedGetImageData, 'getImageData');

    
    // ========================================================================
    // 2. WEBGL FINGERPRINT SPOOFING (—Å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–º–∏ extensions)
    // ========================================================================
    
    const UNMASKED_VENDOR_WEBGL = 37445;
    const UNMASKED_RENDERER_WEBGL = 37446;
    
    // WebGL numeric parameter constants
    const GL_PARAMS = {{
        MAX_TEXTURE_SIZE: 0x0D33,
        MAX_RENDERBUFFER_SIZE: 0x84E8,
        MAX_VIEWPORT_DIMS: 0x0D3A,
        MAX_VERTEX_ATTRIBS: 0x8869,
        MAX_VERTEX_UNIFORM_VECTORS: 0x8DFB,
        MAX_FRAGMENT_UNIFORM_VECTORS: 0x8DFD,
        MAX_VARYING_VECTORS: 0x8DFC,
        MAX_TEXTURE_IMAGE_UNITS: 0x8872,
        MAX_VERTEX_TEXTURE_IMAGE_UNITS: 0x8B4C,
        MAX_COMBINED_TEXTURE_IMAGE_UNITS: 0x8B4D,
        ALIASED_LINE_WIDTH_RANGE: 0x846E,
        ALIASED_POINT_SIZE_RANGE: 0x846D
    }};
    
    // Reverse lookup: GL constant -> param name
    const GL_PARAM_NAMES = {{}};
    for (const [name, val] of Object.entries(GL_PARAMS)) {{
        GL_PARAM_NAMES[val] = name;
    }}
    
    const originalGetParameter = WebGLRenderingContext.prototype.getParameter;
    const originalGetParameter2 = WebGL2RenderingContext.prototype.getParameter;
    const originalGetSupportedExtensions = WebGLRenderingContext.prototype.getSupportedExtensions;
    const originalGetSupportedExtensions2 = WebGL2RenderingContext.prototype.getSupportedExtensions;
    
    const createGetParameterProxy = (original) => {{
        return new Proxy(original, {{
            apply(target, thisArg, args) {{
                const param = args[0];
                if (param === UNMASKED_VENDOR_WEBGL) {{
                    log('WebGL vendor requested');
                    return SPOOF_CONFIG.webgl.vendor;
                }}
                if (param === UNMASKED_RENDERER_WEBGL) {{
                    log('WebGL renderer requested');
                    return SPOOF_CONFIG.webgl.renderer;
                }}
                
                // Numeric params spoofing - –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ —Å GPU
                const paramName = GL_PARAM_NAMES[param];
                if (paramName && SPOOF_CONFIG.webgl.params[paramName] !== undefined) {{
                    const spoofedValue = SPOOF_CONFIG.webgl.params[paramName];
                    log('WebGL param', paramName, ':', spoofedValue);
                    // –î–ª—è –º–∞—Å—Å–∏–≤–æ–≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º Float32Array –∏–ª–∏ Int32Array
                    if (Array.isArray(spoofedValue)) {{
                        return new Float32Array(spoofedValue);
                    }}
                    return spoofedValue;
                }}
                
                return Reflect.apply(target, thisArg, args);
            }}
        }});
    }};
    
    // –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ extensions –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ GPU
    const createGetSupportedExtensionsProxy = (original) => {{
        return new Proxy(original, {{
            apply(target, thisArg, args) {{
                log('WebGL extensions requested');
                return SPOOF_CONFIG.webgl.extensions;
            }}
        }});
    }};
    
    const spoofedGetParameter = createGetParameterProxy(originalGetParameter);
    const spoofedGetParameter2 = createGetParameterProxy(originalGetParameter2);
    const spoofedGetSupportedExtensions = createGetSupportedExtensionsProxy(originalGetSupportedExtensions);
    const spoofedGetSupportedExtensions2 = createGetSupportedExtensionsProxy(originalGetSupportedExtensions2);
    
    spoofedFunctions.set(spoofedGetParameter, 'getParameter');
    spoofedFunctions.set(spoofedGetParameter2, 'getParameter');
    spoofedFunctions.set(spoofedGetSupportedExtensions, 'getSupportedExtensions');
    spoofedFunctions.set(spoofedGetSupportedExtensions2, 'getSupportedExtensions');
    
    // ========================================================================
    // 3. AUDIO FINGERPRINT SPOOFING
    // ========================================================================
    // AWS FWCIM –º–æ–¥—É–ª—å 53 —Å–æ–±–∏—Ä–∞–µ—Ç –∞—É–¥–∏–æ-–æ—Ç–ø–µ—á–∞—Ç–æ–∫ —á–µ—Ä–µ–∑ AudioContext
    // ========================================================================
    
    const addAudioNoise = (data) => {{
        if (!data || !data.length) return;
        for (let i = 0; i < data.length; i++) {{
            data[i] += (seededRandom() - 0.5) * 0.0000001;
        }}
    }};
    
    // AudioBuffer.getChannelData - –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–æ –ø–æ–∑–∂–µ —á–µ—Ä–µ–∑ safeDefineProperty
    let spoofedGetChannelData = null;
    let spoofedGetFloatFrequencyData = null;
    let spoofedGetByteFrequencyData = null;
    
    if (typeof AudioBuffer !== 'undefined') {{
        const originalGetChannelData = AudioBuffer.prototype.getChannelData;
        spoofedGetChannelData = new Proxy(originalGetChannelData, {{
            apply(target, thisArg, args) {{
                const result = Reflect.apply(target, thisArg, args);
                addAudioNoise(result);
                log('AudioBuffer.getChannelData spoofed');
                return result;
            }}
        }});
        spoofedFunctions.set(spoofedGetChannelData, 'getChannelData');
    }}
    
    if (typeof AnalyserNode !== 'undefined') {{
        const originalGetFloatFrequencyData = AnalyserNode.prototype.getFloatFrequencyData;
        spoofedGetFloatFrequencyData = new Proxy(originalGetFloatFrequencyData, {{
            apply(target, thisArg, args) {{
                Reflect.apply(target, thisArg, args);
                if (args[0]) addAudioNoise(args[0]);
                log('AnalyserNode.getFloatFrequencyData spoofed');
            }}
        }});
        spoofedFunctions.set(spoofedGetFloatFrequencyData, 'getFloatFrequencyData');
        
        const originalGetByteFrequencyData = AnalyserNode.prototype.getByteFrequencyData;
        spoofedGetByteFrequencyData = new Proxy(originalGetByteFrequencyData, {{
            apply(target, thisArg, args) {{
                Reflect.apply(target, thisArg, args);
                if (args[0]) {{
                    for (let i = 0; i < args[0].length; i++) {{
                        args[0][i] = Math.max(0, Math.min(255, args[0][i] + Math.floor((seededRandom() - 0.5) * 2)));
                    }}
                }}
            }}
        }});
        spoofedFunctions.set(spoofedGetByteFrequencyData, 'getByteFrequencyData');
    }}

    
    // ========================================================================
    // 4. toString() STEALTH v2.0 - –£–°–ò–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
    // ========================================================================
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –í–°–ï –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–∑–æ–≤–∞:
    // - func.toString()
    // - Function.prototype.toString.call(func)
    // - Function.prototype.toString.apply(func)
    // ========================================================================
    
    const nativeToString = Function.prototype.toString;
    
    const stealthToString = new Proxy(nativeToString, {{
        apply(target, thisArg, args) {{
            // thisArg - —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è, —É –∫–æ—Ç–æ—Ä–æ–π –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è toString
            // –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è .call(), .apply() –∏ –ø—Ä—è–º–æ–≥–æ –≤—ã–∑–æ–≤–∞
            if (spoofedFunctions.has(thisArg)) {{
                const name = spoofedFunctions.get(thisArg);
                log('toString() stealth for:', name);
                return `function ${{name}}() {{ [native code] }}`;
            }}
            
            // –ú–∞—Å–∫–∏—Ä—É–µ–º —Å–∞–º stealthToString
            if (thisArg === stealthToString) {{
                return 'function toString() {{ [native code] }}';
            }}
            
            return Reflect.apply(target, thisArg, args);
        }},
        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º .call –∏ .apply –Ω–∞ —Å–∞–º–æ–º toString
        get(target, prop, receiver) {{
            if (prop === 'call' || prop === 'apply') {{
                return function(...args) {{
                    const func = args[0];
                    if (spoofedFunctions.has(func)) {{
                        const name = spoofedFunctions.get(func);
                        return `function ${{name}}() {{ [native code] }}`;
                    }}
                    return target[prop](...args);
                }};
            }}
            return Reflect.get(target, prop, receiver);
        }}
    }});
    
    // ========================================================================
    // 5. SCREEN RESOLUTION SPOOFING
    // ========================================================================
    // AWS FWCIM –º–æ–¥—É–ª—å 55 –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞–∑–º–µ—Ä—ã —ç–∫—Ä–∞–Ω–∞
    // Headless —á–∞—Å—Ç–æ –∏–º–µ–µ—Ç 800x600, —á—Ç–æ –ø–∞–ª–µ–≤–Ω–æ
    // ========================================================================
    
    // Screen –∏ Navigator properties –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —á–µ—Ä–µ–∑ safeDefineProperty –≤ –∫–æ–Ω—Ü–µ
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
    const screenConfig = SPOOF_CONFIG.screen;
    
    // plugins - –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –≤—ã–¥–∞—ë—Ç headless
    const fakePlugins = [
        {{ name: 'Chrome PDF Plugin', filename: 'internal-pdf-viewer', description: 'Portable Document Format' }},
        {{ name: 'Chrome PDF Viewer', filename: 'mhjfbmdgcfjbbpaeojofohoefgiehjai', description: '' }},
        {{ name: 'Native Client', filename: 'internal-nacl-plugin', description: '' }}
    ];
    const pluginArray = Object.create(PluginArray.prototype);
    fakePlugins.forEach((p, i) => {{ pluginArray[i] = p; }});
    try {{ Object.defineProperty(pluginArray, 'length', {{ value: fakePlugins.length, configurable: true }}); }} catch(e) {{}}
    
    // Navigator properties –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —á–µ—Ä–µ–∑ safeDefineProperty –≤ –∫–æ–Ω—Ü–µ
    
    // ========================================================================
    // 8. NOTIFICATION & PERMISSIONS
    // ========================================================================
    
    let spoofedPermissionsQuery = null;
    if (navigator.permissions) {{
        const originalQuery = navigator.permissions.query;
        spoofedPermissionsQuery = (parameters) => {{
            return originalQuery.call(navigator.permissions, parameters).then(result => {{
                if (result.state === 'denied' && 
                    ['notifications', 'push', 'midi'].includes(parameters.name)) {{
                    return {{ state: 'prompt', onchange: null }};
                }}
                return result;
            }});
        }};
        spoofedFunctions.set(spoofedPermissionsQuery, 'query');
    }}
    
    // ========================================================================
    // 9. CHROME RUNTIME (–¥–ª—è –æ–±—Ö–æ–¥–∞ –¥–µ—Ç–µ–∫—Ç–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π)
    // ========================================================================
    
    // –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–∞–π—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç –Ω–∞–ª–∏—á–∏–µ chrome.runtime
    if (!window.chrome) {{
        window.chrome = {{}};
    }}
    if (!window.chrome.runtime) {{
        window.chrome.runtime = {{}};
    }}
    
    // ========================================================================
    // 10. PROPERTY DESCRIPTOR CONSISTENCY
    // ========================================================================
    // AWS –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã —á–µ—Ä–µ–∑ Object.getOwnPropertyDescriptor
    // –ù–∞—à–∏ –ø–æ–¥–º–µ–Ω—ã –¥–æ–ª–∂–Ω—ã –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ
    // ========================================================================
    
    const originalGetOwnPropertyDescriptor = Object.getOwnPropertyDescriptor;
    Object.getOwnPropertyDescriptor = function(obj, prop) {{
        const desc = originalGetOwnPropertyDescriptor.call(Object, obj, prop);
        
        // –î–ª—è –Ω–∞—à–∏—Ö –ø–æ–¥–º–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞–µ–º "–Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ" –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã
        if (desc && desc.value && spoofedFunctions.has(desc.value)) {{
            return {{
                value: desc.value,
                writable: true,
                enumerable: true,
                configurable: true
            }};
        }}
        
        return desc;
    }};
    
    // ========================================================================
    // –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ü–û–î–ú–ï–ù (—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π)
    // ========================================================================
    
    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤
    const safeDefineProperty = (obj, prop, descriptor) => {{
        try {{
            const existing = Object.getOwnPropertyDescriptor(obj, prop);
            // –ï—Å–ª–∏ —Å–≤–æ–π—Å—Ç–≤–æ —É–∂–µ –Ω–µ configurable, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            if (existing && !existing.configurable) {{
                log('Cannot redefine non-configurable property:', prop);
                return false;
            }}
            Object.defineProperty(obj, prop, descriptor);
            return true;
        }} catch (e) {{
            log('Failed to define property:', prop, e.message);
            return false;
        }}
    }};
    
    // toString –ø–µ—Ä–≤—ã–º - –í–ê–ñ–ù–û: writable –∏ configurable –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å true
    safeDefineProperty(Function.prototype, 'toString', {{
        value: stealthToString,
        writable: true,
        configurable: true
    }});
    
    // Canvas
    safeDefineProperty(HTMLCanvasElement.prototype, 'toDataURL', {{
        value: spoofedToDataURL,
        writable: true,
        configurable: true
    }});
    safeDefineProperty(HTMLCanvasElement.prototype, 'toBlob', {{
        value: spoofedToBlob,
        writable: true,
        configurable: true
    }});
    safeDefineProperty(CanvasRenderingContext2D.prototype, 'getImageData', {{
        value: spoofedGetImageData,
        writable: true,
        configurable: true
    }});
    
    // WebGL
    safeDefineProperty(WebGLRenderingContext.prototype, 'getParameter', {{
        value: spoofedGetParameter,
        writable: true,
        configurable: true
    }});
    safeDefineProperty(WebGL2RenderingContext.prototype, 'getParameter', {{
        value: spoofedGetParameter2,
        writable: true,
        configurable: true
    }});
    safeDefineProperty(WebGLRenderingContext.prototype, 'getSupportedExtensions', {{
        value: spoofedGetSupportedExtensions,
        writable: true,
        configurable: true
    }});
    safeDefineProperty(WebGL2RenderingContext.prototype, 'getSupportedExtensions', {{
        value: spoofedGetSupportedExtensions2,
        writable: true,
        configurable: true
    }});
    
    // Audio
    if (spoofedGetChannelData) {{
        safeDefineProperty(AudioBuffer.prototype, 'getChannelData', {{
            value: spoofedGetChannelData,
            writable: true,
            configurable: true
        }});
    }}
    if (spoofedGetFloatFrequencyData) {{
        safeDefineProperty(AnalyserNode.prototype, 'getFloatFrequencyData', {{
            value: spoofedGetFloatFrequencyData,
            writable: true,
            configurable: true
        }});
    }}
    if (spoofedGetByteFrequencyData) {{
        safeDefineProperty(AnalyserNode.prototype, 'getByteFrequencyData', {{
            value: spoofedGetByteFrequencyData,
            writable: true,
            configurable: true
        }});
    }}
    
    // Screen properties
    const screenProps = ['width', 'height', 'availWidth', 'availHeight', 'colorDepth', 'pixelDepth'];
    for (const prop of screenProps) {{
        if (screenConfig[prop] !== undefined) {{
            safeDefineProperty(screen, prop, {{
                get: () => screenConfig[prop],
                configurable: true
            }});
        }}
    }}
    
    // Window dimensions
    safeDefineProperty(window, 'innerWidth', {{ get: () => screenConfig.width, configurable: true }});
    safeDefineProperty(window, 'innerHeight', {{ get: () => screenConfig.availHeight, configurable: true }});
    safeDefineProperty(window, 'outerWidth', {{ get: () => screenConfig.width, configurable: true }});
    safeDefineProperty(window, 'outerHeight', {{ get: () => screenConfig.height, configurable: true }});
    
    // Navigator properties
    safeDefineProperty(navigator, 'webdriver', {{ get: () => undefined, configurable: true }});
    safeDefineProperty(navigator, 'plugins', {{ get: () => pluginArray, configurable: true }});
    safeDefineProperty(navigator, 'languages', {{ get: () => ['en-US', 'en'], configurable: true }});
    safeDefineProperty(navigator, 'hardwareConcurrency', {{ get: () => 8, configurable: true }});
    safeDefineProperty(navigator, 'deviceMemory', {{ get: () => 8, configurable: true }});
    safeDefineProperty(navigator, 'maxTouchPoints', {{ get: () => 0, configurable: true }});
    // Platform –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å User-Agent (Win32 –¥–ª—è Windows)
    safeDefineProperty(navigator, 'platform', {{ get: () => SPOOF_CONFIG.navigator.platform, configurable: true }});
    
    // Notification
    if (typeof Notification !== 'undefined') {{
        safeDefineProperty(Notification, 'permission', {{ get: () => 'default', configurable: true }});
    }}
    
    // Permissions
    if (spoofedPermissionsQuery) {{
        navigator.permissions.query = spoofedPermissionsQuery;
    }}
    
    // ========================================================================
    // 11. CDP ARTIFACTS REMOVAL (–ö–†–ò–¢–ò–ß–ù–û)
    // ========================================================================
    // Chrome —Å–æ–∑–¥–∞—ë—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ cdc_* –ø—Ä–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ CDP
    // AWS –º–æ–¥—É–ª—å 65 –∏—â–µ—Ç —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    // ========================================================================
    
    const removeCDC = () => {{
        try {{
            for (const prop in window) {{
                if (prop.match(/cdc_[a-z0-9]/ig) || prop.match(/^\\$cdc_/)) {{
                    delete window[prop];
                }}
            }}
        }} catch (e) {{}}
    }};
    removeCDC();
    setInterval(removeCDC, 50);
    
    // ========================================================================
    // 12. WEBRTC IP LEAK PROTECTION
    // ========================================================================
    // –ë–ª–æ–∫–∏—Ä—É–µ–º WebRTC –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —É—Ç–µ—á–∫–∏ —Ä–µ–∞–ª—å–Ω–æ–≥–æ IP
    // ========================================================================
    
    const rtcConfig = {{ iceServers: [], iceTransportPolicy: 'relay' }};
    
    if (window.RTCPeerConnection) {{
        const originalRTC = window.RTCPeerConnection;
        window.RTCPeerConnection = new Proxy(originalRTC, {{
            construct(target, args) {{
                if (args.length > 0) args[0] = rtcConfig;
                return new target(...args);
            }}
        }});
        spoofedFunctions.set(window.RTCPeerConnection, 'RTCPeerConnection');
    }}
    if (window.webkitRTCPeerConnection) {{
        window.webkitRTCPeerConnection = window.RTCPeerConnection;
    }}
    
    // ========================================================================
    // 13. VISIBILITY API SPOOFING
    // ========================================================================
    // –í headless —Ä–µ–∂–∏–º–µ visibilityState = 'hidden', —á—Ç–æ –ø–∞–ª–µ–≤–Ω–æ
    // ========================================================================
    
    try {{
        Object.defineProperty(document, 'visibilityState', {{
            get: () => 'visible',
            configurable: true
        }});
        Object.defineProperty(document, 'hidden', {{
            get: () => false,
            configurable: true
        }});
    }} catch(e) {{ log('visibilityState spoof failed:', e.message); }}
    window.addEventListener('visibilitychange', (e) => e.stopImmediatePropagation(), true);
    
    // ========================================================================
    // 14. BATTERY API MOCK
    // ========================================================================
    // Headless —á–∞—Å—Ç–æ –Ω–µ –∏–º–µ–µ—Ç Battery API –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    // –†–µ–∞–ª—å–Ω–∞—è –±–∞—Ç–∞—Ä–µ—è –∏–º–µ–µ—Ç –¥–∏—Å–∫—Ä–µ—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (0.95, 0.96), –Ω–µ 0.95123812
    // ========================================================================
    
    if (navigator.getBattery) {{
        // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ 2 –∑–Ω–∞–∫–æ–≤ - —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –±–∞—Ç–∞—Ä–µ–∏
        const batteryLevel = parseFloat((0.85 + (seededRandom() * 0.14)).toFixed(2));
        const mockBattery = {{
            charging: true,
            chargingTime: 0,
            dischargingTime: Infinity,
            level: batteryLevel,
            addEventListener: () => {{}},
            removeEventListener: () => {{}}
        }};
        const spoofedGetBattery = () => Promise.resolve(mockBattery);
        navigator.getBattery = spoofedGetBattery;
        spoofedFunctions.set(spoofedGetBattery, 'getBattery');
    }}
    
    // ========================================================================
    // 15. FONTS FINGERPRINTING - –£–î–ê–õ–ï–ù–û
    // ========================================================================
    // offsetWidth/offsetHeight —à—É–º –≤—ã–∑—ã–≤–∞–µ—Ç "–¥—Ä–µ–±–µ–∑–≥" - —ç—Ç–æ 100% –¥–µ—Ç–µ–∫—Ç –±–æ—Ç–∞
    // –†–µ–∞–ª—å–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è –û–° –∏ –Ω–µ –º–µ–Ω—è—é—Ç —Ä–∞–∑–º–µ—Ä —Å–ª—É—á–∞–π–Ω–æ
    // ========================================================================
    
    // ========================================================================
    // 16. CLIENT RECTS - –û–¢–ö–õ–Æ–ß–ï–ù–û
    // ========================================================================
    // getBoundingClientRect —à—É–º –£–î–ê–õ–Å–ù - –º–æ–∂–µ—Ç –ª–æ–º–∞—Ç—å –∫–ª–∏–∫–∏ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
    // AWS FWCIM –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –≤–µ–∫—Ç–æ—Ä –¥–µ—Ç–µ–∫—Ç–∞
    // ========================================================================
    
    // ========================================================================
    // 17. TIMEZONE SPOOFING (–ö–†–ò–¢–ò–ß–ù–û - –¥–æ–ª–∂–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å IP!)
    // ========================================================================
    // Geo-IP mismatch - 100% –ø—Ä–∏–∑–Ω–∞–∫ –ø—Ä–æ–∫—Å–∏/—Å–ø—É—Ñ–∏–Ω–≥–∞
    // –¢–∞–π–º–∑–æ–Ω–∞ –±–µ—Ä—ë—Ç—Å—è –∏–∑ SPOOF_CONFIG.timezone
    // ========================================================================
    
    const originalGetTimezoneOffset = Date.prototype.getTimezoneOffset;
    Date.prototype.getTimezoneOffset = function() {{
        return SPOOF_CONFIG.timezone.offset;
    }};
    spoofedFunctions.set(Date.prototype.getTimezoneOffset, 'getTimezoneOffset');
    
    try {{
        const originalDateTimeFormat = Intl.DateTimeFormat;
        Intl.DateTimeFormat = new Proxy(originalDateTimeFormat, {{
            construct(target, args) {{
                args[0] = args[0] || SPOOF_CONFIG.timezone.locale;
                args[1] = {{ ...args[1], timeZone: SPOOF_CONFIG.timezone.id }};
                return new target(...args);
            }}
        }});
    }} catch(e) {{}}
    
    // –¢–∞–∫–∂–µ —Å–ø—É—Ñ–∏–º resolvedOptions –¥–ª—è –ø–æ–ª–Ω–æ–π —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏
    try {{
        const origResolvedOptions = Intl.DateTimeFormat.prototype.resolvedOptions;
        Intl.DateTimeFormat.prototype.resolvedOptions = function() {{
            const result = origResolvedOptions.call(this);
            result.timeZone = SPOOF_CONFIG.timezone.id;
            result.locale = SPOOF_CONFIG.timezone.locale;
            return result;
        }};
    }} catch(e) {{}}
    
    // ========================================================================
    // 18. MEDIA DEVICES SPOOFING (—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è Windows)
    // ========================================================================
    // –°—Ç–µ—Ä–∏–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–∏–ø–∞ "Default Audio Input" –≤—ã–¥–∞—é—Ç headless/Linux
    // ========================================================================
    
    if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {{
        const spoofedEnumerateDevices = () => Promise.resolve(SPOOF_CONFIG.audio.devices);
        navigator.mediaDevices.enumerateDevices = spoofedEnumerateDevices;
        spoofedFunctions.set(spoofedEnumerateDevices, 'enumerateDevices');
    }}
    
    // ========================================================================
    // 19. IFRAME INJECTION (MutationObserver - –Ω–µ onload!)
    // ========================================================================
    // –ö—Ä–∏—Ç–∏—á–Ω–æ: onload —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ü–û–°–õ–ï —Ç–æ–≥–æ –∫–∞–∫ —Å–∫—Ä–∏–ø—Ç –≤–Ω—É—Ç—Ä–∏ iframe
    // —É–∂–µ –ø–æ–ª—É—á–∏–ª –¥–æ—Å—Ç—É–ø –∫ —á–∏—Å—Ç—ã–º –æ–±—ä–µ–∫—Ç–∞–º. MutationObserver —Ä–µ–∞–≥–∏—Ä—É–µ—Ç
    // –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ —É–∑–ª–∞ –≤ DOM.
    // ========================================================================
    
    const injectIntoFrame = (iframe) => {{
        try {{
            const win = iframe.contentWindow;
            if (!win || win.__FP_SPOOF_INJECTED__) return;
            
            // –ü—ã—Ç–∞–µ–º—Å—è –∏–Ω–∂–µ–∫—Ç–∏—Ç—å –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            win.__FP_SPOOF_INJECTED__ = true;
            
            // –ö–æ–ø–∏—Ä—É–µ–º –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–æ–¥–º–µ–Ω—ã –≤ iframe
            const iframeDoc = win.document;
            if (iframeDoc) {{
                // Navigator
                try {{ Object.defineProperty(win.navigator, 'webdriver', {{ get: () => undefined, configurable: true }}); }} catch(e) {{}}
                
                // Canvas - —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ
                try {{
                    const iframeToDataURL = win.HTMLCanvasElement.prototype.toDataURL;
                    win.HTMLCanvasElement.prototype.toDataURL = function(...args) {{
                        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—Ç –∂–µ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —à—É–º
                        return spoofedToDataURL.apply(this, args);
                    }};
                }} catch(e) {{}}
                
                log('Injected spoofing into iframe');
            }}
        }} catch(e) {{
            // Cross-origin iframe - –Ω–µ –º–æ–∂–µ–º –∏–Ω–∂–µ–∫—Ç–∏—Ç—å
            log('Cannot inject into cross-origin iframe');
        }}
    }};
    
    // MutationObserver –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ iframe
    const iframeObserver = new MutationObserver((mutations) => {{
        for (const mutation of mutations) {{
            for (const node of mutation.addedNodes) {{
                if (node.tagName === 'IFRAME') {{
                    injectIntoFrame(node);
                    // –¢–∞–∫–∂–µ –Ω–∞ load –¥–ª—è about:blank —Ñ—Ä–µ–π–º–æ–≤
                    node.addEventListener('load', () => injectIntoFrame(node));
                }}
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–ª–æ–∂–µ–Ω–Ω—ã–µ iframe
                if (node.querySelectorAll) {{
                    node.querySelectorAll('iframe').forEach(injectIntoFrame);
                }}
            }}
        }}
    }});
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å
    if (document.documentElement) {{
        iframeObserver.observe(document.documentElement, {{ childList: true, subtree: true }});
    }}
    
    // –ò–Ω–∂–µ–∫—Ç–∏–º –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ iframe
    document.querySelectorAll('iframe').forEach(injectIntoFrame);
    
    // ========================================================================
    // 20. WEB WORKER HOOK + BLOB URL INJECTION
    // ========================================================================
    // Web Workers —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞ –∫ DOM.
    // AWS FWCIM –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Workers –¥–ª—è fingerprinting.
    // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º URL.createObjectURL —á—Ç–æ–±—ã –∏–Ω–∂–µ–∫—Ç–∏—Ç—å –∫–æ–¥ –≤ Blob Workers.
    // ========================================================================
    
    // –ö–æ–¥ –¥–ª—è –∏–Ω—ä–µ–∫—Ü–∏–∏ –≤ Worker - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä —Å–ø—É—Ñ–∏–Ω–≥–∞
    const WORKER_SPOOF_CODE = `
        // Worker Fingerprint Spoofing
        const _origNav = self.navigator;
        const _navProxy = new Proxy(_origNav, {{
            get(target, prop) {{
                if (prop === 'hardwareConcurrency') return 8;
                if (prop === 'deviceMemory') return 8;
                if (prop === 'platform') return '${{SPOOF_CONFIG.navigator.platform}}';
                if (prop === 'userAgent') return target.userAgent;
                if (prop === 'language') return 'en-US';
                if (prop === 'languages') return ['en-US', 'en'];
                return target[prop];
            }}
        }});
        try {{ Object.defineProperty(self, 'navigator', {{ get: () => _navProxy, configurable: true }}); }} catch(e) {{}}
        
        // Performance timing noise
        if (self.performance && self.performance.now) {{
            const _origNow = self.performance.now.bind(self.performance);
            self.performance.now = () => _origNow() + (Math.random() * 0.001);
        }}
    `;
    
    // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º URL.createObjectURL –¥–ª—è –∏–Ω—ä–µ–∫—Ü–∏–∏ –≤ Blob Workers
    const originalCreateObjectURL = URL.createObjectURL;
    URL.createObjectURL = function(obj) {{
        if (obj instanceof Blob && obj.type && obj.type.includes('javascript')) {{
            log('Intercepted Blob URL creation for Worker');
            // –ß–∏—Ç–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à —Å–ø—É—Ñ–∏–Ω–≥ –≤ –Ω–∞—á–∞–ª–æ
            return new Promise((resolve) => {{
                const reader = new FileReader();
                reader.onload = () => {{
                    const originalCode = reader.result;
                    const modifiedCode = WORKER_SPOOF_CODE + '\\n' + originalCode;
                    const newBlob = new Blob([modifiedCode], {{ type: obj.type }});
                    resolve(originalCreateObjectURL.call(URL, newBlob));
                }};
                reader.readAsText(obj);
            }}).catch(() => originalCreateObjectURL.call(URL, obj));
        }}
        return originalCreateObjectURL.call(URL, obj);
    }};
    spoofedFunctions.set(URL.createObjectURL, 'createObjectURL');
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è —Å–ª—É—á–∞–µ–≤ –∫–æ–≥–¥–∞ Promise –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç
    const originalCreateObjectURLSync = URL.createObjectURL;
    
    const OriginalWorker = window.Worker;
    if (OriginalWorker) {{
        window.Worker = function(scriptURL, options) {{
            log('Worker created:', scriptURL);
            
            // –î–ª—è Blob –æ–±—ä–µ–∫—Ç–æ–≤ - —Å–æ–∑–¥–∞—ë–º –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Blob
            if (scriptURL instanceof Blob) {{
                log('Worker uses Blob - injecting spoof code');
                // –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º Blob (–Ω–µ –∏–¥–µ–∞–ª—å–Ω–æ, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç)
                try {{
                    const modifiedBlob = new Blob([WORKER_SPOOF_CODE, scriptURL], {{ type: scriptURL.type || 'application/javascript' }});
                    const blobUrl = originalCreateObjectURLSync.call(URL, modifiedBlob);
                    return new OriginalWorker(blobUrl, options);
                }} catch(e) {{
                    log('Blob injection failed:', e.message);
                }}
            }}
            
            return new OriginalWorker(scriptURL, options);
        }};
        
        // –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞
        window.Worker.prototype = OriginalWorker.prototype;
        spoofedFunctions.set(window.Worker, 'Worker');
    }}
    
    // ========================================================================
    // –ì–û–¢–û–í–û v3.3
    // ========================================================================
    
    log('Fingerprint spoofing v3.3 initialized');
    log('GPU:', SPOOF_CONFIG.webgl.vendor, '/', SPOOF_CONFIG.webgl.renderer);
    log('Screen:', SPOOF_CONFIG.screen.width, 'x', SPOOF_CONFIG.screen.height);
    log('Timezone:', SPOOF_CONFIG.timezone.id, '(offset', SPOOF_CONFIG.timezone.offset + ')');
    log('Extensions:', SPOOF_CONFIG.webgl.extensions.length);
    log('WebGL Params:', Object.keys(SPOOF_CONFIG.webgl.params).length);
    log('Platform:', SPOOF_CONFIG.navigator.platform);
    log('Modules: Canvas, WebGL+Params, Audio, Screen, Navigator+Platform, WebRTC, Battery, Timezone(dynamic), MediaDevices(Win), IFrame, Worker+BlobInjection');
    
    window.__FP_SPOOF_CONFIG__ = SPOOF_CONFIG;
}})();
'''



class FingerprintSpoofer:
    """
    –ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è fingerprint spoofing –≤ DrissionPage v2.0
    
    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
        from fingerprint_spoof import FingerprintSpoofer
        from DrissionPage import ChromiumPage
        
        page = ChromiumPage()
        spoofer = FingerprintSpoofer(page)
        spoofer.inject()
        
        page.get('https://browserleaks.com/canvas')
    """
    
    def __init__(self, page, gpu_profile: str = None, screen_resolution: str = None,
                 timezone: str = None, canvas_noise: float = CANVAS_NOISE_ALPHA, seed: int = None):
        """
        Args:
            page: DrissionPage ChromiumPage instance
            gpu_profile: –ò–º—è –ø—Ä–æ—Ñ–∏–ª—è GPU (intel_uhd_620, nvidia_gtx_1650, etc.)
            screen_resolution: –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞ (1920x1080, 2560x1440, etc.)
            timezone: –¢–∞–π–º–∑–æ–Ω–∞ (europe_moscow, america_new_york, etc.) - –î–û–õ–ñ–ù–ê —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å IP!
            canvas_noise: –£—Ä–æ–≤–µ–Ω—å —à—É–º–∞ Canvas
            seed: Seed –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏
        """
        self.page = page
        self.canvas_noise = canvas_noise
        self.seed = seed
        self._injected = False
        
        # –í—ã–±–∏—Ä–∞–µ–º GPU –ø—Ä–æ—Ñ–∏–ª—å
        if gpu_profile and gpu_profile in GPU_PROFILES:
            self.gpu_profile = GPU_PROFILES[gpu_profile].copy()
        else:
            if seed:
                random.seed(seed)
            self.gpu_profile = generate_gpu_profile()
        
        # –í—ã–±–∏—Ä–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞
        if screen_resolution:
            parts = screen_resolution.split('x')
            if len(parts) == 2:
                w, h = int(parts[0]), int(parts[1])
                self.screen_config = {
                    "width": w, "height": h,
                    "availWidth": w, "availHeight": h - 40
                }
            else:
                self.screen_config = generate_screen_config()
        else:
            self.screen_config = generate_screen_config()
        
        # –í—ã–±–∏—Ä–∞–µ–º —Ç–∞–π–º–∑–æ–Ω—É - –ö–†–ò–¢–ò–ß–ù–û –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è IP!
        if timezone and timezone in TIMEZONE_PROFILES:
            self.timezone_config = TIMEZONE_PROFILES[timezone].copy()
        else:
            # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ú–æ—Å–∫–≤–∞ (–¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö IP)
            self.timezone_config = TIMEZONE_PROFILES["europe_moscow"].copy()
    
    def get_js_payload(self) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç JS –∫–æ–¥ –¥–ª—è –∏–Ω—ä–µ–∫—Ü–∏–∏"""
        return get_stealth_js(
            gpu_profile=self.gpu_profile,
            screen_config=self.screen_config,
            timezone_config=self.timezone_config,
            canvas_noise=self.canvas_noise,
            seed=self.seed
        )
    
    def inject(self) -> bool:
        """
        –ò–Ω—ä–µ–∫—Ç–∏—Ä—É–µ—Ç stealth —Å–∫—Ä–∏–ø—Ç –≤ –±—Ä–∞—É–∑–µ—Ä
        –°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –î–û –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç CDP Page.addScriptToEvaluateOnNewDocument
        
        Returns:
            True –µ—Å–ª–∏ –∏–Ω—ä–µ–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–∞
        """
        if self._injected:
            return True
        
        try:
            js_payload = self.get_js_payload()
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º CDP –Ω–∞–ø—Ä—è–º—É—é - —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–æ –≤—Å–µ—Ö –≤–µ—Ä—Å–∏—è—Ö DrissionPage
            # Page.addScriptToEvaluateOnNewDocument –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–∫—Ä–∏–ø—Ç –î–û –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            try:
                self.page.run_cdp('Page.addScriptToEvaluateOnNewDocument', source=js_payload)
            except Exception as cdp_err:
                # Fallback: –ø–æ–ø—Ä–æ–±—É–µ–º —Å—Ç–∞—Ä—ã–π API
                try:
                    self.page.set.script_on_load(js_payload)
                except:
                    # –ü–æ—Å–ª–µ–¥–Ω–∏–π fallback - –ø—Ä–æ—Å—Ç–æ –≤—ã–ø–æ–ª–Ω–∏–º —Å–∫—Ä–∏–ø—Ç
                    self.page.run_js(js_payload)
            
            self._injected = True
            print(f"üõ°Ô∏è Fingerprint spoofing v3.3 injected")
            print(f"   GPU: {self.gpu_profile['vendor']} / {self.gpu_profile['renderer']}")
            print(f"   Screen: {self.screen_config['width']}x{self.screen_config['height']}")
            print(f"   Timezone: {self.timezone_config['id']} (offset {self.timezone_config['offset']})")
            print(f"   Extensions: {len(self.gpu_profile.get('extensions', []))}")
            print(f"   WebGL Params: {len(self.gpu_profile.get('params', {}))}")
            print(f"   Modules: Canvas, WebGL+Params, Audio, Navigator+Platform, Timezone, Worker+BlobInjection")
            return True
            
        except Exception as e:
            print(f"‚ö†Ô∏è Failed to inject fingerprint spoof: {e}")
            return False
    
    def get_config(self) -> dict:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–ø—É—Ñ–∏–Ω–≥–∞"""
        return {
            "gpu_vendor": self.gpu_profile['vendor'],
            "gpu_renderer": self.gpu_profile['renderer'],
            "extensions_count": len(self.gpu_profile.get('extensions', [])),
            "webgl_params_count": len(self.gpu_profile.get('params', {})),
            "screen_width": self.screen_config['width'],
            "screen_height": self.screen_config['height'],
            "timezone_id": self.timezone_config['id'],
            "timezone_offset": self.timezone_config['offset'],
            "canvas_noise": self.canvas_noise,
            "seed": self.seed,
            "injected": self._injected
        }


# Legacy compatibility
def generate_webgl_config() -> dict:
    """Legacy: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é WebGL"""
    profile = generate_gpu_profile()
    return {
        "vendor": profile["vendor"],
        "renderer": profile["renderer"]
    }


# ============================================================================
# –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï
# ============================================================================

def test_fingerprint_spoof():
    """–¢–µ—Å—Ç fingerprint spoofing v2.0"""
    from DrissionPage import ChromiumPage, ChromiumOptions
    
    print("=" * 60)
    print("Fingerprint Spoofing PoC v2.0 Test")
    print("=" * 60)
    
    co = ChromiumOptions()
    co.set_argument('--disable-blink-features=AutomationControlled')
    
    page = ChromiumPage(co)
    spoofer = FingerprintSpoofer(page, seed=12345)
    spoofer.inject()
    
    print("\n–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:")
    config = spoofer.get_config()
    for key, value in config.items():
        print(f"  {key}: {value}")
    
    print("\nüìç Opening browserleaks.com/canvas...")
    page.get('https://browserleaks.com/canvas')
    
    print("\n‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Canvas Signature")
    input("\n–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ WebGL...")
    
    page.get('https://browserleaks.com/webgl')
    print("\n‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ WebGL Vendor, Renderer –∏ Extensions")
    
    input("\n–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è...")
    page.quit()
    print("\n‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω")


if __name__ == '__main__':
    test_fingerprint_spoof()
"""
AWS Builder ID Auto-Registration
–ì–ª–∞–≤–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    python register.py                    # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
    python register.py --email user@whitebite.ru
    python register.py --file emails.txt
    python register.py --count 5          # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 5 email –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å
"""

import argparse
import time
from typing import List, Optional

import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent))

from core.config import get_config
from .browser import BrowserAutomation
from .oauth_client import OAuthClient
from .mail_handler import get_mail_handler

# –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
config = get_config()
TIMEOUTS = {
    'page_load': config.timeouts.page_load,
    'element_wait': config.timeouts.element_wait,
    'verification_code': config.timeouts.verification_code,
    'oauth_callback': config.timeouts.oauth_callback,
    'between_accounts': config.timeouts.between_accounts,
    'imap_poll_interval': config.timeouts.imap_poll_interval,
}


class AccountStorage:
    """–ü—Ä–æ—Å—Ç–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)"""
    def __init__(self):
        from core.paths import get_paths
        self.paths = get_paths()
        self.filepath = self.paths.accounts_file
        self._ensure_file()
    
    def _ensure_file(self):
        if not self.filepath.exists():
            self.filepath.write_text('[]', encoding='utf-8')
    
    def load_all(self) -> list:
        import json
        try:
            return json.loads(self.filepath.read_text(encoding='utf-8'))
        except:
            return []
    
    def save(self, email: str, password: str, name: str, token_file=None) -> dict:
        import json
        import time
        accounts = self.load_all()
        account = {
            'email': email,
            'password': password,
            'name': name,
            'token_file': token_file,
            'created_at': time.strftime('%Y-%m-%d %H:%M:%S'),
            'status': 'active'
        }
        accounts.append(account)
        self.filepath.write_text(json.dumps(accounts, indent=2, ensure_ascii=False), encoding='utf-8')
        return account
    
    def count(self) -> dict:
        accounts = self.load_all()
        return {
            'total': len(accounts),
            'active': len([a for a in accounts if a.get('status') == 'active']),
            'failed': len([a for a in accounts if a.get('status') == 'failed']),
        }


class AWSRegistration:
    """–ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ AWS Builder ID"""
    
    def __init__(self, headless: bool = False, spoof_fingerprint: bool = True):
        self.storage = AccountStorage()
        self.headless = headless
        self.spoof_fingerprint = spoof_fingerprint
        self.browser = None
        self.mail_handler = None
    
    def _init_mail(self, email_domain: str):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –ø–æ—á—Ç—ã"""
        if not self.mail_handler:
            self.mail_handler = get_mail_handler(email_domain)
        return self.mail_handler
    
    def register_single(self, email: str, name: Optional[str] = None, 
                       password: Optional[str] = None) -> dict:
        """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–¥–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ (–±–µ–∑ callback)"""
        return self.register_single_with_progress(email, name, password, None)
    
    def register_single_with_progress(self, email: str, name: Optional[str] = None, 
                                      password: Optional[str] = None,
                                      progress_callback=None) -> dict:
        """
        –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–¥–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ —Å callback –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        
        Args:
            email: Email –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            name: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ email)
            password: –ü–∞—Ä–æ–ª—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è)
            progress_callback: —Ñ—É–Ω–∫—Ü–∏—è(step, total, name, detail)
        
        Returns:
            dict —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        """
        def progress(step, total, name, detail=""):
            if progress_callback:
                progress_callback(step, total, name, detail)
            print(f"[{step}/{total}] {name}: {detail}")
        
        if name is None:
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –∏–∑ email: JohnSmith1234 -> John Smith
            username = email.split('@')[0]
            # –£–±–∏—Ä–∞–µ–º —Ü–∏—Ñ—Ä—ã –≤ –∫–æ–Ω—Ü–µ
            import re
            name_part = re.sub(r'\d+$', '', username)
            # –†–∞–∑–¥–µ–ª—è–µ–º CamelCase: JohnSmith -> John Smith
            name = re.sub(r'([a-z])([A-Z])', r'\1 \2', name_part)
        
        if password is None:
            password = BrowserAutomation.generate_password()
        
        email_domain = email.split('@')[1]
        mail_handler = self._init_mail(email_domain)
        
        if not mail_handler:
            return {'email': email, 'success': False, 'error': 'Mail handler not available'}
        
        oauth = OAuthClient()
        
        try:
            # 1. –ó–∞–ø—É—Å–∫–∞–µ–º OAuth —Å–µ—Ä–≤–µ—Ä
            progress(2, 8, "OAuth", "Starting server...")
            
            auth_url = oauth.start(account_name=name)
            if not auth_url:
                return {'email': email, 'success': False, 'error': 'Failed to get auth URL'}
            
            # 2. –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –±—Ä–∞—É–∑–µ—Ä (—á–∏—Å—Ç—ã–π, –±–µ–∑ –∫—ç—à–∞)
            progress(3, 8, "Browser", "Opening page...")
            if self.browser:
                self.browser.close()
            self.browser = BrowserAutomation(headless=self.headless, spoof_fingerprint=self.spoof_fingerprint)
            
            # 3. –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            self.browser.navigate(auth_url)
            
            # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—à–∏–±–∫—É AWS
            if self.browser.check_aws_error():
                return {'email': email, 'success': False, 'error': 'AWS temporary error, try again later'}
            
            # 4. –ó–∞–∫—Ä—ã–≤–∞–µ–º cookie
            self.browser.close_cookie_dialog()
            
            # 5. –í–≤–æ–¥–∏–º email
            progress(4, 8, "Email", f"Entering {email}")
            self.browser.enter_email(email)
            self.browser.click_continue()
            
            # 5. –í–≤–æ–¥–∏–º –∏–º—è
            self.browser.enter_name(name)
            
            # 6. –ü–æ–ª—É—á–∞–µ–º –∏ –≤–≤–æ–¥–∏–º –∫–æ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
            progress(5, 8, "Verification", "Waiting for email code...")
            code = mail_handler.get_verification_code(email, timeout=TIMEOUTS['verification_code'])
            
            if not code:
                return {'email': email, 'success': False, 'error': 'Verification code not received'}
            
            progress(5, 8, "Verification", f"Code: {code}")
            self.browser.enter_verification_code(code)
            
            # 7. –í–≤–æ–¥–∏–º –ø–∞—Ä–æ–ª—å
            progress(6, 8, "Password", "Setting password...")
            self.browser.enter_password(password)
            
            # 8. Allow access
            progress(7, 8, "Authorization", "Allowing access...")
            self.browser.click_allow_access()
            
            # 9. –ñ–¥—ë–º callback
            if self.browser.wait_for_callback():
                # –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è OAuth
                oauth.wait_for_callback(timeout=30)
                token_file = oauth.get_token_filename()
                
                # Debug: log token file
                print(f"[DEBUG] Token file from OAuth: {token_file}")
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫–∫–∞—É–Ω—Ç
                self.storage.save(email, password, name, token_file)
                
                progress(8, 8, "Complete", f"Account created: {email}, token: {token_file}")
                return {
                    'email': email,
                    'password': password,
                    'name': name,
                    'token_file': token_file,
                    'success': True
                }
            else:
                return {'email': email, 'success': False, 'error': 'Callback timeout'}
                
        except Exception as e:
            return {'email': email, 'success': False, 'error': str(e)}
        
        finally:
            oauth.close()
    
    def register_batch(self, emails: List[str], names: List[str] = None) -> List[dict]:
        """
        –ü–∞–∫–µ—Ç–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        
        Args:
            emails: –°–ø–∏—Å–æ–∫ email –∞–¥—Ä–µ—Å–æ–≤
            names: –°–ø–∏—Å–æ–∫ –∏–º—ë–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        
        Returns:
            –°–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        """
        if names is None:
            names = [e.split('@')[0] for e in emails]
        
        results = []
        
        for i, (email, name) in enumerate(zip(emails, names)):
            print(f"\n{'='*60}")
            print(f"–ê–∫–∫–∞—É–Ω—Ç {i+1}/{len(emails)}")
            print('='*60)
            
            result = self.register_single(email, name)
            results.append(result)
            
            # –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è–º–∏
            if i < len(emails) - 1:
                print(f"\n‚è≥ –ü–∞—É–∑–∞ {TIMEOUTS['between_accounts']} —Å–µ–∫—É–Ω–¥...")
                time.sleep(TIMEOUTS['between_accounts'])
        
        return results
    
    def print_summary(self, results: List[dict]):
        """–í—ã–≤–æ–¥–∏—Ç –∏—Ç–æ–≥–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"""
        print("\n" + "="*60)
        print("üìä –ò–¢–û–ì–ò")
        print("="*60)
        
        success = [r for r in results if r.get('success')]
        failed = [r for r in results if not r.get('success')]
        
        print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ: {len(success)}")
        print(f"‚ùå –û—à–∏–±–∫–∏: {len(failed)}")
        
        if success:
            print("\n–£—Å–ø–µ—à–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:")
            for r in success:
                print(f"  {r['email']} : {r['password']}")
        
        if failed:
            print("\n–û—à–∏–±–∫–∏:")
            for r in failed:
                print(f"  {r['email']} - {r.get('error', 'Unknown')}")
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
        stats = self.storage.count()
        print(f"\n–í—Å–µ–≥–æ –≤ –±–∞–∑–µ: {stats['total']} –∞–∫–∫–∞—É–Ω—Ç–æ–≤")
    
    def close(self):
        """–ó–∞–∫—Ä—ã—Ç–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤"""
        if self.mail_handler:
            self.mail_handler.disconnect()
        if self.browser:
            self.browser.close()


def generate_realistic_name() -> tuple[str, str]:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ –∏–º–µ–Ω–∏ –∏ —Ñ–∞–º–∏–ª–∏–∏"""
    import random
    
    # –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –∏–º–µ–Ω–∞
    first_names = [
        'James', 'John', 'Robert', 'Michael', 'David', 'William', 'Richard', 'Joseph',
        'Thomas', 'Christopher', 'Charles', 'Daniel', 'Matthew', 'Anthony', 'Mark',
        'Donald', 'Steven', 'Paul', 'Andrew', 'Joshua', 'Kenneth', 'Kevin', 'Brian',
        'George', 'Timothy', 'Ronald', 'Edward', 'Jason', 'Jeffrey', 'Ryan',
        'Mary', 'Patricia', 'Jennifer', 'Linda', 'Barbara', 'Elizabeth', 'Susan',
        'Jessica', 'Sarah', 'Karen', 'Lisa', 'Nancy', 'Betty', 'Margaret', 'Sandra',
        'Ashley', 'Kimberly', 'Emily', 'Donna', 'Michelle', 'Dorothy', 'Carol',
        'Amanda', 'Melissa', 'Deborah', 'Stephanie', 'Rebecca', 'Sharon', 'Laura',
        'Alex', 'Sam', 'Jordan', 'Taylor', 'Morgan', 'Casey', 'Riley', 'Quinn'
    ]
    
    # –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Ñ–∞–º–∏–ª–∏–∏
    last_names = [
        'Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis',
        'Rodriguez', 'Martinez', 'Hernandez', 'Lopez', 'Gonzalez', 'Wilson', 'Anderson',
        'Thomas', 'Taylor', 'Moore', 'Jackson', 'Martin', 'Lee', 'Perez', 'Thompson',
        'White', 'Harris', 'Sanchez', 'Clark', 'Ramirez', 'Lewis', 'Robinson',
        'Walker', 'Young', 'Allen', 'King', 'Wright', 'Scott', 'Torres', 'Nguyen',
        'Hill', 'Flores', 'Green', 'Adams', 'Nelson', 'Baker', 'Hall', 'Rivera',
        'Campbell', 'Mitchell', 'Carter', 'Roberts', 'Turner', 'Phillips', 'Evans',
        'Parker', 'Edwards', 'Collins', 'Stewart', 'Morris', 'Murphy', 'Cook'
    ]
    
    return random.choice(first_names), random.choice(last_names)


def generate_emails(count: int, domain: str = 'whitebite.ru', prefix: str = 'kiro_auto') -> List[tuple[str, str]]:
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ email –∞–¥—Ä–µ—Å–æ–≤ —Å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏
    –§–æ—Ä–º–∞—Ç: –ò–º—è–§–∞–º–∏–ª–∏—è + —Å–ª—É—á–∞–π–Ω—ã–µ —Ü–∏—Ñ—Ä—ã (JohnSmith1234@domain)
    
    Returns:
        List of tuples (email, full_name)
    """
    import random
    
    results = []
    used_emails = set()
    
    for _ in range(count):
        first_name, last_name = generate_realistic_name()
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π email
        attempts = 0
        while attempts < 100:
            number = random.randint(100, 9999)  # 3-4 —Ü–∏—Ñ—Ä—ã
            username = f"{first_name}{last_name}{number}"  # JohnSmith1234
            email = f"{username}@{domain}"
            
            if email.lower() not in used_emails:
                used_emails.add(email.lower())
                full_name = f"{first_name} {last_name}"
                results.append((email, full_name))
                break
            attempts += 1
    
    return results


def main():
    parser = argparse.ArgumentParser(description='AWS Builder ID Auto-Registration')
    parser.add_argument('--email', '-e', help='Email –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏')
    parser.add_argument('--file', '-f', help='–§–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º email')
    parser.add_argument('--count', '-c', type=int, help='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏')
    parser.add_argument('--headless', action='store_true', help='–ó–∞–ø—É—Å–∫ –±–µ–∑ GUI')
    parser.add_argument('--export', action='store_true', help='–≠–∫—Å–ø–æ—Ä—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –≤ —Ñ–∞–π–ª')
    parser.add_argument('--list', action='store_true', help='–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã')
    parser.add_argument('--delete-all', action='store_true', help='–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã')
    parser.add_argument('--delete-failed', action='store_true', help='–£–¥–∞–ª–∏—Ç—å failed –∞–∫–∫–∞—É–Ω—Ç—ã')
    parser.add_argument('--delete', type=str, help='–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –ø–æ email')
    
    args = parser.parse_args()
    
    storage = AccountStorage()
    
    # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏
    if args.list:
        storage.list_all()
        return
    
    if args.delete_all:
        confirm = input("‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –í–°–ï –∞–∫–∫–∞—É–Ω—Ç—ã? (yes/no): ").strip().lower()
        if confirm == 'yes':
            storage.delete_all()
        else:
            print("–û—Ç–º–µ–Ω–µ–Ω–æ")
        return
    
    if args.delete_failed:
        storage.delete_failed()
        return
    
    if args.delete:
        storage.delete_by_email(args.delete)
        return
    
    # –≠–∫—Å–ø–æ—Ä—Ç
    if args.export:
        storage.export_credentials()
        return
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ø–∏—Å–æ–∫ email –∏ –∏–º—ë–Ω
    emails = []
    names = None
    
    if args.email:
        emails = [args.email]
    elif args.file:
        with open(args.file) as f:
            emails = [line.strip() for line in f if line.strip() and '@' in line]
    elif args.count:
        generated = generate_emails(args.count)
        emails = [e for e, _ in generated]
        names = [n for _, n in generated]
        print(f"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ {len(emails)} –∞–∫–∫–∞—É–Ω—Ç–æ–≤:")
        for email, name in generated:
            print(f"  {name} <{email}>")
    else:
        # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
        print("=" * 60)
        print("AWS Builder ID Auto-Registration")
        print("=" * 60)
        print("\n–†–µ–∂–∏–º—ã:")
        print("1. –û–¥–∏–Ω –∞–∫–∫–∞—É–Ω—Ç")
        print("2. –ò–∑ —Ñ–∞–π–ª–∞")
        print("3. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å N –∞–∫–∫–∞—É–Ω—Ç–æ–≤")
        print("4. –≠–∫—Å–ø–æ—Ä—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤")
        print("5. –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã")
        print("6. –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã")
        print("7. –£–¥–∞–ª–∏—Ç—å failed –∞–∫–∫–∞—É–Ω—Ç—ã")
        
        mode = input("\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º (1-7): ").strip()
        
        if mode == '1':
            email = input("Email (@whitebite.ru): ").strip()
            if not email.endswith('@whitebite.ru'):
                print("‚ùå –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ @whitebite.ru")
                return
            emails = [email]
        
        elif mode == '2':
            filepath = input("–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É: ").strip()
            with open(filepath) as f:
                emails = [line.strip() for line in f if line.strip() and '@' in line]
        
        elif mode == '3':
            count = int(input("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ").strip())
            generated = generate_emails(count)
            emails = [e for e, _ in generated]
            names = [n for _, n in generated]
            print(f"\n–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ:")
            for email, name in generated:
                print(f"  {name} <{email}>")
        
        elif mode == '4':
            storage.export_credentials()
            return
        
        elif mode == '5':
            storage.list_all()
            return
        
        elif mode == '6':
            confirm = input("‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –í–°–ï –∞–∫–∫–∞—É–Ω—Ç—ã? (yes/no): ").strip().lower()
            if confirm == 'yes':
                storage.delete_all()
            else:
                print("–û—Ç–º–µ–Ω–µ–Ω–æ")
            return
        
        elif mode == '7':
            storage.delete_failed()
            return
        
        else:
            print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ä–µ–∂–∏–º")
            return
    
    if not emails:
        print("‚ùå –ù–µ—Ç email –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏")
        return
    
    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    print(f"\n–ë—É–¥–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ: {len(emails)} –∞–∫–∫–∞—É–Ω—Ç–æ–≤")
    confirm = input("–ù–∞—á–∞—Ç—å? (y/n): ").strip().lower()
    
    if confirm != 'y':
        print("–û—Ç–º–µ–Ω–µ–Ω–æ")
        return
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    reg = AWSRegistration(headless=args.headless)
    
    try:
        results = reg.register_batch(emails, names)
        reg.print_summary(results)
    finally:
        reg.close()


if __name__ == '__main__':
    main()
"""
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –±–µ–∑ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
–° –≤—ã–≤–æ–¥–æ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–ª—è VS Code extension
"""
import sys
import time
import json
import argparse
import random
from pathlib import Path

# Add parent directory to path for imports when running as script
sys.path.insert(0, str(Path(__file__).parent.parent))

from .register import AWSRegistration, generate_emails
from core.config import get_config, save_config

def get_setting(path, default=None):
    return get_config().get(path, default)

def set_setting(path, value):
    config = get_config()
    config.set(path, value)
    save_config()


# –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∏–º–µ–Ω–∞ –∏ —Ñ–∞–º–∏–ª–∏–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–µ–ª–æ–≤–µ–∫–æ–ø–æ–¥–æ–±–Ω—ã—Ö email
FIRST_NAMES = [
    'James', 'John', 'Robert', 'Michael', 'David', 'William', 'Richard', 'Joseph',
    'Thomas', 'Christopher', 'Charles', 'Daniel', 'Matthew', 'Anthony', 'Mark',
    'Steven', 'Paul', 'Andrew', 'Joshua', 'Kevin', 'Brian', 'George', 'Edward',
    'Mary', 'Patricia', 'Jennifer', 'Linda', 'Elizabeth', 'Susan', 'Jessica',
    'Sarah', 'Karen', 'Lisa', 'Nancy', 'Betty', 'Margaret', 'Sandra', 'Ashley',
    'Emily', 'Amanda', 'Melissa', 'Stephanie', 'Rebecca', 'Laura', 'Helen',
    'Alex', 'Sam', 'Jordan', 'Taylor', 'Morgan', 'Casey', 'Riley', 'Quinn',
    'Max', 'Ben', 'Jake', 'Ryan', 'Nick', 'Tom', 'Jack', 'Luke', 'Adam', 'Eric'
]

LAST_NAMES = [
    'Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis',
    'Rodriguez', 'Martinez', 'Wilson', 'Anderson', 'Taylor', 'Thomas', 'Moore',
    'Jackson', 'Martin', 'Lee', 'Thompson', 'White', 'Harris', 'Clark', 'Lewis',
    'Walker', 'Young', 'Allen', 'King', 'Wright', 'Scott', 'Green', 'Baker',
    'Adams', 'Nelson', 'Hill', 'Campbell', 'Mitchell', 'Roberts', 'Carter',
    'Phillips', 'Evans', 'Turner', 'Parker', 'Collins', 'Edwards', 'Stewart',
    'Morris', 'Murphy', 'Cook', 'Rogers', 'Morgan', 'Peterson', 'Cooper', 'Reed'
]


def generate_human_email(domain: str = 'whitebite.ru') -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —á–µ–ª–æ–≤–µ–∫–æ–ø–æ–¥–æ–±–Ω—ã–π email —Ç–∏–ø–∞ JohnSmith1234@domain
    –§–æ—Ä–º–∞—Ç –≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π: –ò–º—è–§–∞–º–∏–ª–∏—è + —Å–ª—É—á–∞–π–Ω—ã–µ —Ü–∏—Ñ—Ä—ã
    """
    first = random.choice(FIRST_NAMES)
    last = random.choice(LAST_NAMES)
    number = random.randint(100, 9999)  # 3-4 —Ü–∏—Ñ—Ä—ã
    
    # –ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: JohnSmith1234
    username = f"{first}{last}{number}"
    return f"{username}@{domain}"


def progress(step: int, total: int, name: str, detail: str = ""):
    """–í—ã–≤–æ–¥–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è extension"""
    data = {
        "step": step,
        "totalSteps": total,
        "stepName": name,
        "detail": detail
    }
    print(f"PROGRESS:{json.dumps(data)}")
    sys.stdout.flush()


def main():
    parser = argparse.ArgumentParser(description='Auto-register AWS Builder ID')
    parser.add_argument('--headless', action='store_true', help='Run browser in headless mode')
    parser.add_argument('--no-headless', action='store_true', help='Show browser window (default)')
    parser.add_argument('--verbose', '-v', action='store_true', help='Verbose output')
    parser.add_argument('--no-spoof', action='store_true', help='Disable fingerprint spoofing')
    parser.add_argument('--email', type=str, help='Custom email to use')
    parser.add_argument('--domain', type=str, default='whitebite.ru', help='Email domain')
    parser.add_argument('--prefix', type=str, default='kiro_auto', help='Email prefix')
    args = parser.parse_args()
    
    # Determine headless mode
    if args.headless:
        headless = True
    elif args.no_headless:
        headless = False
    else:
        # Use config setting
        headless = get_setting('browser.headless', False)
    
    # Update config if verbose
    if args.verbose:
        set_setting('debug.verbose', True)
    
    # Generate email
    if args.email:
        email = args.email
    else:
        email = generate_human_email(args.domain)
    
    progress(1, 8, "Initializing", f"Email: {email}")
    
    # Determine spoof mode
    spoof_fingerprint = not args.no_spoof
    
    if args.verbose:
        print(f"[DEBUG] Headless: {headless}")
        print(f"[DEBUG] Spoof fingerprint: {spoof_fingerprint}")
        print(f"[DEBUG] Email: {email}")
    
    reg = AWSRegistration(headless=headless, spoof_fingerprint=spoof_fingerprint)
    
    try:
        progress(2, 8, "Starting OAuth", "Getting auth URL...")
        
        result = reg.register_single_with_progress(email, progress_callback=progress)
        
        if result.get('success'):
            progress(8, 8, "Complete", f"Account: {result['email']}")
            print("\n‚úÖ SUCCESS")
            print(f"Email: {result['email']}")
            print(f"Password: {result['password']}")
            print(f"Token: {result.get('token_file', 'N/A')}")
        else:
            progress(8, 8, "Failed", result.get('error', 'Unknown error'))
            print(f"\n‚ùå FAILED: {result.get('error', 'Unknown')}")
            
        return result
        
    except Exception as e:
        progress(8, 8, "Error", str(e))
        print(f"\n‚ùå ERROR: {e}")
        if args.verbose:
            import traceback
            traceback.print_exc()
        return {'success': False, 'error': str(e)}
        
    finally:
        reg.close()


if __name__ == '__main__':
    main()
