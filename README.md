# ⚡ Kiro Account Switcher

Расширение для тех, кто устал ебаться с лимитами Kiro.

> ⚠️ **ДИСКЛЕЙМЕР**
>
> Это учебный проект, написанный в образовательных целях для изучения работы с VS Code Extension API, OAuth потоками и автоматизацией браузера.
>
> Автор не несёт никакой ответственности за использование этого кода. Всё что вы делаете — вы делаете на свой страх и риск. Если вас забанят, заблокируют, отключат, уволят или случится что-то ещё — это ваши проблемы. Я предупредил.
>
> Используя этот код вы подтверждаете что понимаете что делаете и принимаете все последствия.

---

## Что это такое

Расширение для Kiro IDE которое позволяет:

- **Хранить несколько аккаунтов** и переключаться между ними в один клик
- **Видеть usage** каждого аккаунта — сколько запросов потрачено, сколько осталось, когда рефреш
- **Автоматически регистрировать новые аккаунты** прямо из интерфейса (нужна почта с IMAP)
- **Рефрешить токены** — вручную или автоматически перед истечением
- **Экспортировать список аккаунтов** в JSON
- **Копировать токены и пароли** в буфер обмена

Всё это живёт в удобной боковой панели с нормальным UI, а не в консоли как у дикарей.

---

## Как это работает

### Переключение аккаунтов

Kiro хранит токен авторизации в своей внутренней базе (`state.vscdb`). Расширение:

1. Читает токены из папки `~/.kiro-batch-login/tokens/`
2. При переключении — записывает выбранный токен в базу Kiro
3. Kiro подхватывает новый токен и работает под другим аккаунтом

Перезапуск IDE не нужен. Переключение занимает пару секунд.

### Usage tracking

Расширение читает данные об использовании из той же базы Kiro и показывает:

- Текущий расход запросов
- Лимит аккаунта
- Процент использования
- Время до сброса лимита

Данные кэшируются локально, так что даже если переключился на другой аккаунт — видно статистику по всем.

### Авторег

Самая мясная часть. Расширение может автоматически:

1. Сгенерировать email на указанном домене
2. Открыть браузер (Playwright)
3. Пройти регистрацию на AWS/Kiro
4. Получить код подтверждения с почты через IMAP
5. Ввести код, завершить регистрацию
6. Сохранить токен в папку с токенами

Всё это без участия человека. Ну, почти — иногда бывает капча.

---

## Установка

### Из релиза (рекомендуется)

1. Скачать `.vsix` из [Releases](../../releases)
2. Открыть Kiro
3. `Ctrl+Shift+P` → `Extensions: Install from VSIX`
4. Выбрать скачанный файл
5. Перезапустить Kiro

### Из исходников

```bash
git clone <repo>
cd kiro-extension
npm install
npm run package
```

Получится файл `kiro-account-switcher-X.X.X.vsix` — ставить как выше.

---

## Настройка

Все настройки: `Ctrl+,` → поиск `kiroAccountSwitcher`

### Основные

| Настройка                    | Описание                                      | По умолчанию                 |
| ---------------------------- | --------------------------------------------- | ---------------------------- |
| `tokensPath`                 | Путь к папке с токенами                       | `~/.kiro-batch-login/tokens` |
| `autoSwitch.enabled`         | Автоматический рефреш токена перед истечением | `false`                      |
| `autoSwitch.intervalMinutes` | За сколько минут до истечения рефрешить       | `50`                         |

### IMAP (для авторега)

| Настройка             | Описание                       | Пример              |
| --------------------- | ------------------------------ | ------------------- |
| `imap.server`         | Адрес IMAP сервера             | `mail.example.com`  |
| `imap.user`           | Логин (обычно email)           | `admin@example.com` |
| `imap.password`       | Пароль                         | `***`               |
| `autoreg.emailDomain` | Домен для генерации email'ов   | `example.com`       |
| `autoreg.headless`    | Скрыть браузер при регистрации | `false`             |

### Дебаг

| Настройка                  | Описание                     | По умолчанию |
| -------------------------- | ---------------------------- | ------------ |
| `debug.verbose`            | Подробные логи в консоль     | `false`      |
| `debug.screenshotsOnError` | Делать скриншоты при ошибках | `true`       |

---

## Формат токенов

Токены хранятся в `~/.kiro-batch-login/tokens/` как JSON файлы:

```json
{
  "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6...",
  "refreshToken": "eyJjdHkiOiJKV1QiLCJlbmMiOi...",
  "expiresAt": "2024-12-10T20:00:00.000Z",
  "accountName": "user@example.com",
  "email": "user@example.com",
  "idToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6..."
}
```

Имя файла может быть любым, расширение `.json`. Расширение читает все файлы из папки.

Можно добавлять токены вручную — просто кинуть JSON файл в папку и нажать Refresh.

---

## Использование авторега

### Требования

- Python 3.10+
- Почтовый сервер с IMAP доступом
- Домен для email'ов (catch-all или отдельные ящики)

### Первый запуск

1. Настроить IMAP в настройках расширения
2. Нажать кнопку **Auto-Reg** в панели
3. Подождать — при первом запуске установятся зависимости:
   - `playwright` (браузер)
   - `imapclient` (работа с почтой)
   - и прочее из `requirements.txt`
4. Откроется браузер, пойдёт регистрация
5. После успеха — токен появится в списке

### Что может пойти не так

- **Капча** — иногда AWS показывает капчу. Придётся решить руками или перезапустить.
- **Почта не приходит** — проверить IMAP настройки, посмотреть логи.
- **Браузер не открывается** — проверить что Playwright установлен: `playwright install chromium`
- **Python не найден** — убедиться что `python` или `python3` в PATH.

Логи пишутся в `~/.kiro-batch-login/autoreg.log` и в консоль расширения.

---

## Команды

Доступны через `Ctrl+Shift+P`:

| Команда                         | Что делает                           |
| ------------------------------- | ------------------------------------ |
| `Kiro: Switch Account`          | Быстрое переключение через QuickPick |
| `Kiro: List Available Accounts` | Обновить список аккаунтов            |
| `Kiro: Import Token from File`  | Импортировать токен из JSON файла    |
| `Kiro: Show Current Account`    | Показать текущий аккаунт             |
| `Kiro: Sign Out`                | Выйти из текущего аккаунта           |
| `Kiro: Open Account Dashboard`  | Открыть панель аккаунтов             |

---

## Сборка

### Требования для сборки

- Node.js 18+
- npm

### Команды

```bash
# Установить зависимости
npm install

# Собрать TypeScript
npm run build

# Собрать .vsix пакет
npm run package

# Собрать с копированием autoreg (для локальной разработки)
npm run copy-autoreg && npm run build
```

### CI/CD

В репозитории настроен GitHub Actions:

- Автоматическая сборка на push/PR
- Релиз `.vsix` при создании тега `v*`

---

## Структура проекта

```
kiro-extension/
├── src/
│   ├── extension.ts      # Точка входа, команды, провайдер
│   ├── accounts.ts       # Работа с токенами и аккаунтами
│   ├── utils.ts          # Утилиты, работа с БД Kiro
│   ├── webview.ts        # Генерация HTML для панели
│   ├── types.ts          # TypeScript типы
│   └── webview/          # Компоненты UI
├── autoreg/              # Python скрипты авторега (копируются при сборке)
├── dist/                 # Скомпилированный JS (gitignore)
├── package.json
├── tsconfig.json
└── .vscodeignore
```

---

## Известные проблемы

- **Usage иногда не обновляется** — нажать Refresh или подождать. Kiro кэширует данные.
- **Авторег виснет на капче** — AWS иногда требует капчу. Решить руками или перезапустить.
- **На Linux нужен python3** — убедиться что симлинк есть или настроить PATH.
- **Токен не применяется** — попробовать перезапустить Kiro. Редко, но бывает.

---

## FAQ

**Q: Это легально?**  
A: Это учебный проект. Читай дисклеймер выше.

**Q: Меня забанят?**  
A: Возможно. Читай дисклеймер выше.

**Q: Почему Python для авторега?**  
A: Потому что Playwright на Python удобнее для такой автоматизации, плюс уже был готовый код.

**Q: Можно без авторега?**  
A: Да. Просто не настраивай IMAP и не нажимай кнопку. Переключение аккаунтов работает независимо.

**Q: Как добавить существующий аккаунт?**  
A: Залогиниться в Kiro, найти токен в `state.vscdb`, сохранить в JSON в папку токенов. Или использовать Import.

---

## Лицензия

MIT. Делай что хочешь, но помни про дисклеймер.

---

## Контрибьютинг

Нашёл баг? Есть идея? Открывай issue или PR. Код страшный местами, но работает.
